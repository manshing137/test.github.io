/*! #metadata# bp-nc-sdk: 1.4.11-388f1675 (Wed Dec 08 2021 11:25:19 GMT+0800 (China Standard Time)) mode: production*/
var e,t;e=window,t=function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=32)}([function(e,t,r){"use strict";r.r(t),r.d(t,"__extends",(function(){return i})),r.d(t,"__assign",(function(){return s})),r.d(t,"__rest",(function(){return o})),r.d(t,"__decorate",(function(){return a})),r.d(t,"__param",(function(){return c})),r.d(t,"__metadata",(function(){return d})),r.d(t,"__awaiter",(function(){return l})),r.d(t,"__generator",(function(){return u})),r.d(t,"__createBinding",(function(){return h})),r.d(t,"__exportStar",(function(){return p})),r.d(t,"__values",(function(){return f})),r.d(t,"__read",(function(){return m})),r.d(t,"__spread",(function(){return g})),r.d(t,"__spreadArrays",(function(){return v})),r.d(t,"__spreadArray",(function(){return y})),r.d(t,"__await",(function(){return C})),r.d(t,"__asyncGenerator",(function(){return R})),r.d(t,"__asyncDelegator",(function(){return b})),r.d(t,"__asyncValues",(function(){return T})),r.d(t,"__makeTemplateObject",(function(){return S})),r.d(t,"__importStar",(function(){return P})),r.d(t,"__importDefault",(function(){return D})),r.d(t,"__classPrivateFieldGet",(function(){return k})),r.d(t,"__classPrivateFieldSet",(function(){return E}));var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var s=function(){return(s=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function o(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function a(e,t,r,n){var i,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(s<3?i(o):s>3?i(t,r,o):i(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o}function c(e,t){return function(r,n){t(r,n,e)}}function d(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function l(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))}function u(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}var h=Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]};function p(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||h(t,e,r)}function f(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function m(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o}function g(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(m(arguments[t]));return e}function v(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<r;t++)for(var s=arguments[t],o=0,a=s.length;o<a;o++,i++)n[i]=s[o];return n}function y(e,t){for(var r=0,n=t.length,i=e.length;r<n;r++,i++)e[i]=t[r];return e}function C(e){return this instanceof C?(this.v=e,this):new C(e)}function R(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,i=r.apply(e,t||[]),s=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(e){i[e]&&(n[e]=function(t){return new Promise((function(r,n){s.push([e,t,r,n])>1||a(e,t)}))})}function a(e,t){try{(r=i[e](t)).value instanceof C?Promise.resolve(r.value.v).then(c,d):l(s[0][2],r)}catch(e){l(s[0][3],e)}var r}function c(e){a("next",e)}function d(e){a("throw",e)}function l(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}function b(e){var t,r;return t={},n("next"),n("throw",(function(e){throw e})),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,i){t[n]=e[n]?function(t){return(r=!r)?{value:C(e[n](t)),done:"return"===n}:i?i(t):t}:i}}function T(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=f(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,i){!function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)}(n,i,(t=e[r](t)).done,t.value)}))}}}function S(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var _=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};function P(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&h(t,e,r);return _(t,e),t}function D(e){return e&&e.__esModule?e:{default:e}}function k(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)}function E(e,t,r){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,r),r}},function(e,t,r){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(i=n))}),t.splice(i,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=r(38)(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LOG_LEVEL=void 0;const n=r(0).__importDefault(r(7));var i;!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARNING=3]="WARNING",e[e.ERROR=4]="ERROR"}(i=t.LOG_LEVEL||(t.LOG_LEVEL={}));class s{constructor(e=""){this.namespace=e,this.state={level:i.INFO,historyList:[]}}static getInstance(){return s.instance||(s.instance=new s),s.instance}setLevel(e){this.state.level=e}debug(e,...t){this.baseLog([e,...t],i.VERBOSE)}log(e,...t){this.baseLog([e,...t],i.INFO)}warn(e,...t){this.baseLog([e,...t],i.WARNING)}error(e,...t){this.baseLog([e,...t],i.ERROR)}baseLog(e,t=i.INFO){const r=new Date,o={level:t,date:r.toLocaleDateString(),time:r.toTimeString().substr(0,8),timeStamp:r.getTime(),msgArr:e};let a;try{a=JSON.parse(localStorage.getItem("bp_nc_config")||"{}").showNCLog}catch(e){console.log("bp_nc_config error",e)}if(this.state.historyList.push(o),this.state.historyList.length>=s.MAX_LOG_LENGTH&&this.state.historyList.shift(),o.level>=this.state.level&&1===a){const t=`[v${n.default.getInstance().version}]-[${o.date} ${o.time}]-[${o.timeStamp}]`;switch(o.level){case i.WARNING:console.warn(t,...e);break;case i.ERROR:console.error(t,...e);break;case i.VERBOSE:console.debug(t,...e);break;default:console.log(t,...e)}}}getHistory(e=i.INFO){let t="";return this.state.historyList.forEach(r=>{r.level>=e&&(t+=`\n[BPNC ${this.namespace} ${r.time}] ${JSON.stringify(r.msgArr)}`)}),t}reset(){this.state={level:i.INFO,historyList:[]}}}s.MAX_LOG_LENGTH=1e3,t.default=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{}n.TRACK="track",n.SOCKET_CONNECT="socket_connect",n.SOCKET_MESSAGE="socket_message",n.WEBRTC_ANSWER_TIMEOUT="webrtc_answer_timeout",n.WEBRTC_CONNECT_TIMEOUT="webrtc_connect_timeout",n.WEBRTC_CHANNEL_CLOSE="webrtc_channel_close",n.WEBRTC_CHANNEL_OPEN="webrtc_channel_open",n.WEBRTC_GET_DATA_TIMEOUT="webrtc_get_data_timeout",t.default=n},function(e,t,r){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}e.exports=n,n.prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},n.prototype.once=function(e,t){function r(){this.off(e,r),t.apply(this,arguments)}return r.fn=t,this.on(e,r),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r,n=this._callbacks["$"+e];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<n.length;i++)if((r=n[i])===t||r.fn===t){n.splice(i,1);break}return 0===n.length&&delete this._callbacks["$"+e],this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),r=this._callbacks["$"+e],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(r){n=0;for(var i=(r=r.slice(0)).length;n<i;++n)r[n].apply(this,t)}return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{}n.TRACK_TYPE={TEST:1e3,ENTER:1001,QUIT:1002,SAVE_DATA:2001,GET_DATA:2002,OPEN_DB:2003,DB_UPGRADE:2004,OPEN_DB_ERROR:2005,OPEN_DB_SUCCESS:2006,DB_CLOSE:2007,PUT_DB:2008,PUT_DB_SUCCESS:2009,PUT_DB_ERROR:2010,DB_RESOURCE:2011,DEL_DB_ERROR:2012},n.RESOURCE_OPTION={UPDATE:1,ADD:2,DEL:3},n.RESPONSE_CODE={SUCCESS:1,ERROR:-1,FILE_READER_ERROR:-2,ANSWER_INVALID:-3,WEBRTC_OPEN_TIMEOUT:-300,WEBRTC_OPEN_TIMEOUT_BY_NO_LDP:-301,WEBRTC_OPEN_TIMEOUT_BY_NO_RDP:-302,WEBRTC_OPEN_TIMEOUT_BY_NO_RC:-303,WEBRTC_OPEN_TIMEOUT_BY_NO_ACS:-304},n.RTC_STATE_CODE={INIT:1,DATA_CHANNEL_OPEN_SUCCESS:2,DATA_CHANNEL_OPEN_ERROR:3,SEND_DATA_SUCCESS:4,GET_DATA_SUCCESS:5},t.default=n},function(e,t,r){"use strict";var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},n.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},n.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1]}return r},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},n.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},n.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:n.matchPrefix(e+t,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},n.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},n.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?n.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},n.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},n.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},n.getCryptoParameters=function(e,t){return n.matchPrefix(e+t,"a=crypto:").map(n.parseCryptoLine)},n.getIceParameters=function(e,t){var r=n.matchPrefix(e+t,"a=ice-ufrag:")[0],i=n.matchPrefix(e+t,"a=ice-pwd:")[0];return r&&i?{usernameFragment:r.substr(12),password:i.substr(10)}:null},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=n.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var s=r[i],o=n.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){var a=n.parseRtpMap(o),c=n.matchPrefix(e,"a=fmtp:"+s+" ");switch(a.parameters=c.length?n.parseFmtp(c[0]):{},a.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(n.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(n.parseExtmap(e))})),t},n.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=n.writeRtpMap(e),r+=n.writeFmtp(e),r+=n.writeRtcpFb(e)}));var i=0;return t.codecs.forEach((function(e){e.maxptime>i&&(i=e.maxptime)})),i>0&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=n.writeExtmap(e)})),r},n.parseRtpEncodingParameters=function(e){var t,r=[],i=n.parseRtpParameters(e),s=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=n.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(n.rtx={ssrc:t}),r.push(n),s&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},r.push(n))}})),0===r.length&&c&&r.push({ssrc:c});var l=n.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=l}))),r},n.parseRtcpParameters=function(e){var t={},r=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var i=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var s=n.matchPrefix(e,"a=rtcp-mux");return t.mux=s.length>0,t},n.parseMsid=function(e){var t,r=n.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var i=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return i.length>0?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},n.parseSctpDescription=function(e){var t,r=n.parseMLine(e),i=n.matchPrefix(e,"a=max-message-size:");i.length>0&&(t=parseInt(i[0].substr(19),10)),isNaN(t)&&(t=65536);var s=n.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substr(12),10),protocol:r.fmt,maxMessageSize:t};if(n.matchPrefix(e,"a=sctpmap:").length>0){var o=n.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(o[0],10),protocol:o[1],maxMessageSize:t}}},n.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t,r){var i=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||n.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,r,i){var s=n.writeRtpDescription(e.kind,t);if(s+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",e.direction?s+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+o,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),s},n.getDirection=function(e,t){for(var r=n.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){return n.splitLines(e)[0].split(" ")[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},n.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=n.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},e.exports=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(17);class i{constructor(){this.version=n.metadata.version+"-"+n.metadata.hash.substr(0,8)}static getInstance(){return i.instance||(i.instance=new i),i.instance}reset(){}}i.BLOCK_SIZE=1048576,t.default=i},function(e,t,r){const n=r(44),i=r(45),s=String.fromCharCode(30);e.exports={protocol:4,encodePacket:n,encodePayload:(e,t)=>{const r=e.length,i=new Array(r);let o=0;e.forEach((e,a)=>{n(e,!1,e=>{i[a]=e,++o===r&&t(i.join(s))})})},decodePacket:i,decodePayload:(e,t)=>{const r=e.split(s),n=[];for(let e=0;e<r.length;e++){const s=i(r[e],t);if(n.push(s),"error"===s.type)break}return n}}},function(e,t){e.exports="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")()},function(e,t,r){"use strict";var n;function i(e,t,r){if(!r||typeof r.value!==n.typeOfFunction)throw new TypeError("Only methods can be decorated with @bind. <"+t+"> is not a method!");return{configurable:n.boolTrue,get:function(){var e=r.value.bind(this);return Object.defineProperty(this,t,{value:e,configurable:n.boolTrue,writable:n.boolTrue}),e}}}Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.typeOfFunction="function",e.boolTrue=!0}(n||(n={})),t.bind=i,t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(17),i=r(18);class s{static cloneDeep(e,t){if(null===e||"object"!=typeof e)return e;let r;if(s.isTypedArray(e)&&"function"==typeof e.slice)return r=e.slice(),r;r=Array.isArray(e)?[]:{};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const i=e[n];r[n]=t&&"object"==typeof i?s.cloneDeep(i,t):i}return r}static isTypedArray(e){return!!(e&&e.buffer instanceof ArrayBuffer&&e.BYTES_PER_ELEMENT)}static downloadFile(e,t){let r=document.createElement("a"),n=t.slice&&"data:"===t.slice(0,5),i=t.lastIndexOf&&t.lastIndexOf(".")>-1;r.download=e,r.style.display="none",r.href=i||n?t:URL.createObjectURL(new Blob([t])),document.body.appendChild(r),r.click(),document.body.removeChild(r)}static concatArrayBuffer(e,t){if(!e)return t;if(!t)return e;let r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}static concatUint8Array(e,t){if(!e)return t;if(!t)return e;let r=new Uint8Array(e.byteLength+t.byteLength);return r.set(e,0),r.set(t,e.byteLength),r}static encodeUTF8(e){const t=encodeURIComponent(e),r=[];for(let e=0;e<t.length;e++){const n=t.charAt(e);if("%"===n){const n=t.charAt(e+1)+t.charAt(e+2),i=parseInt(n,16);r.push(i),e+=2}else r.push(n.charCodeAt(0))}return new Uint8Array(r)}static decodeUTF8(e){let t="";for(let r=0;r<e.byteLength;r++)t+="%"+e[r].toString(16);return decodeURIComponent(t)}static isChrome(){const e=navigator.userAgent;return-1===e.indexOf("Edge")&&e.indexOf("Chrome")>-1&&e.indexOf("Safari")>-1}static isSupportP2P(){var e;const t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,r=null===(e=window.RTCDataChannel)||void 0===e?void 0:e.prototype.send;return!!(window.indexedDB&&(null==t?void 0:t.prototype.createDataChannel)&&r)}static getCookie(e){if(null==e)return"";const t=document.cookie.split(";"),r=decodeURIComponent(e);for(let e=0;e<t.length;e++){const[n,i]=t[e].trim().split("=");if(decodeURIComponent(n)===r)return decodeURIComponent(i)}return""}static getLocalSettings(e){return window.localStorage&&localStorage.getItem?localStorage.getItem(e):s.getCookie(e)}static randomString(e){const t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=t.length,n=[];for(let i=0;i<e;i++){const e=Math.floor(Math.random()*r);n.push(t[e])}return n.join("")}static get BROWSER_ENV(){return window.location.hostname.includes("pre-")?i.RUNTIME_MODE.PRE:n.metadata.mode}}t.default=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0).__importDefault(r(13));class i{constructor(){this.events=new n.default}static getInstance(){return i.instance||(i.instance=new i),i.instance}one(e,t){var r;null===(r=this.events)||void 0===r||r.one(e,t)}on(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,t){var r;null===(r=this.events)||void 0===r||r.trigger(e,t)}destroy(){this.events&&(this.events.destroy(),this.events=new n.default)}}t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0).__importDefault(r(2));t.default=class{constructor(){this.events={}}on(e,t){"function"==typeof t&&(this.events[e]||(this.events[e]=[]),this.events[e].push(t))}off(e,t){if("function"==typeof t&&this.events[e])if(t){const r=this.events[e].indexOf(t);r>-1&&this.events[e].splice(r,1)}else this.events[e]=[]}one(e,t){if("function"==typeof t){this.events[e]||(this.events[e]=[]);const r=n=>{t(n),this.off(e,r)};this.on(e,r)}}trigger(e,...t){this.events[e]&&this.events[e].length&&[...this.events[e]].forEach(e=>{try{e(...t)}catch(e){n.default.getInstance().error(e)}})}destroy(){this.events={}}}},function(e,t,r){const n=r(8),i=r(4),s=r(1)("engine.io-client:transport");e.exports=class extends i{constructor(e){super(),this.opts=e,this.query=e.query,this.readyState="",this.socket=e.socket}onError(e,t){const r=new Error(e);return r.type="TransportError",r.description=t,this.emit("error",r),this}open(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState?this.write(e):s("transport is not open, discarding packets")}onOpen(){this.readyState="open",this.writable=!0,this.emit("open")}onData(e){const t=n.decodePacket(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){this.emit("packet",e)}onClose(){this.readyState="closed",this.emit("close")}}},function(e,t){t.encode=function(e){var t="";for(var r in e)e.hasOwnProperty(r)&&(t.length&&(t+="&"),t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t},t.decode=function(e){for(var t={},r=e.split("&"),n=0,i=r.length;n<i;n++){var s=r[n].split("=");t[decodeURIComponent(s[0])]=decodeURIComponent(s[1])}return t}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Decoder=t.Encoder=t.PacketType=t.protocol=void 0;const n=r(4),i=r(50),s=r(28),o=r(1)("socket.io-parser");var a;t.protocol=5,function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(a=t.PacketType||(t.PacketType={})),t.Encoder=class{encode(e){return o("encoding packet %j",e),e.type!==a.EVENT&&e.type!==a.ACK||!s.hasBinary(e)?[this.encodeAsString(e)]:(e.type=e.type===a.EVENT?a.BINARY_EVENT:a.BINARY_ACK,this.encodeAsBinary(e))}encodeAsString(e){let t=""+e.type;return e.type!==a.BINARY_EVENT&&e.type!==a.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data)),o("encoded %j as %s",e,t),t}encodeAsBinary(e){const t=i.deconstructPacket(e),r=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(r),n}};class c extends n{constructor(){super()}add(e){let t;if("string"==typeof e)t=this.decodeString(e),t.type===a.BINARY_EVENT||t.type===a.BINARY_ACK?(this.reconstructor=new d(t),0===t.attachments&&super.emit("decoded",t)):super.emit("decoded",t);else{if(!s.isBinary(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emit("decoded",t))}}decodeString(e){let t=0;const r={type:Number(e.charAt(0))};if(void 0===a[r.type])throw new Error("unknown packet type "+r.type);if(r.type===a.BINARY_EVENT||r.type===a.BINARY_ACK){const n=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const i=e.substring(n,t);if(i!=Number(i)||"-"!==e.charAt(t))throw new Error("Illegal attachments");r.attachments=Number(i)}if("/"===e.charAt(t+1)){const n=t+1;for(;++t&&","!==e.charAt(t)&&t!==e.length;);r.nsp=e.substring(n,t)}else r.nsp="/";const n=e.charAt(t+1);if(""!==n&&Number(n)==n){const n=t+1;for(;++t;){const r=e.charAt(t);if(null==r||Number(r)!=r){--t;break}if(t===e.length)break}r.id=Number(e.substring(n,t+1))}if(e.charAt(++t)){const n=function(e){try{return JSON.parse(e)}catch(e){return!1}}(e.substr(t));if(!c.isPayloadValid(r.type,n))throw new Error("invalid payload");r.data=n}return o("decoded %s as %j",e,r),r}static isPayloadValid(e,t){switch(e){case a.CONNECT:return"object"==typeof t;case a.DISCONNECT:return void 0===t;case a.CONNECT_ERROR:return"string"==typeof t||"object"==typeof t;case a.EVENT:case a.BINARY_EVENT:return Array.isArray(t)&&t.length>0;case a.ACK:case a.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}t.Decoder=c;class d{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=i.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.metadata=void 0,t.metadata={name:"browser-client",version:"1.4.11",hash:"388f167",branch:"Detached: 388f1675cc157d8220f5783be60d8666d406f212",lastModified:"Wed Dec 08 2021 11:25:19 GMT+0800 (China Standard Time)",mode:"production"}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DISTRIBUTION_BASEURL=t.CODE_RATIO_MAP=t.CLEAR_MAP=t.RATIO_MAP=t.RTC_LOAD_TYPE=t.RUNTIME_MODE=t.OPERATION=t.HOT_PUSH_FROM=t.DEVICE_TYPE=t.REDIS_KEY=t.STRING=void 0,t.STRING={BOX:"box",BROWSER:"browser",AUTO_HOT_PUSH:"autoHotPush",CLIENT:"client",RESOURCE:"resource",RESOURCES:"resources",HOT_RESOURCES:"hotResources",NO_RESOURCES:"noResources",SIDS:"sids",PRID:"prid",PRIDS:"prids",BP_NC_TRACKER:"bpNcTracker",CLIENT_NUM:"clientNum",LAST_ACTIVE_TIME:"lastActiveTime",URLS:"urls",DISPATCH:"dispatch",SEARCHINFO:"searchInfo",MD5S:"md5s"},t.REDIS_KEY={SIDS_BOX:"sids:box",PRIDS_QUIT:"prids:quit",PRIDS_CONNECT:"prids:connect",PRIDS_LAST_ACTIVE_TIME:"prids:lastActiveTime",CONNECT_NUM_BOX:"connect:num:box",TOP_CID_LIST_SET_NAME:"topCIDListKey",TOP_AID_LIST_SET_NAME:"topAIDListKey",ENABLED_CID_LIST_SET_NAME:"enabledCIDListKey",MD5_RESOURCES:"md5:resources",MD5_INVALID:"md5:invalid"},t.DEVICE_TYPE={BROWSER:0,BOX:1,AUTO_HOT_PUSH:2,RESOURCE_MD5_VOTE:3},t.HOT_PUSH_FROM={HAND_HOT_PUSH:1,AUTO_HOT_PUSH:2,EM_HOT_PUSH:3,EXTRA_HOT_PUSH:4},t.OPERATION={UPDATE:1,ADD:2,REMOVE:3},t.RUNTIME_MODE={PROD:"production",DEV:"development",PRE:"preliminary"},t.RTC_LOAD_TYPE={SEND:1,GET:2},t.RATIO_MAP={H264:.75,H265:.25,STANDARD:.75,UNSTANDARD:.25},t.CLEAR_MAP={V_1080P:2656,V_720P:1200,V_480P:500,V_1080PP:652,V_360P:200,V_1080P60:322},t.CODE_RATIO_MAP=[{code:"30011",msg:"360P-h265",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H265},{code:"30015",msg:"360P-h264-非标准",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H264*t.RATIO_MAP.UNSTANDARD},{code:"30016",msg:"360P-h264-标准",ratio:t.CLEAR_MAP.V_360P*t.RATIO_MAP.H264*t.RATIO_MAP.STANDARD},{code:"30033",msg:"480P-h265",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H265},{code:"30029",msg:"480P-h264-非标准",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H264*t.RATIO_MAP.UNSTANDARD},{code:"30032",msg:"480P-h264-标准",ratio:t.CLEAR_MAP.V_480P*t.RATIO_MAP.H264*t.RATIO_MAP.STANDARD},{code:"30066",msg:"720P-h265",ratio:t.CLEAR_MAP.V_720P*t.RATIO_MAP.H265},{code:"30064",msg:"720P-h264",ratio:t.CLEAR_MAP.V_720P*t.RATIO_MAP.H264},{code:"30077",msg:"1080P-h265",ratio:t.CLEAR_MAP.V_1080P*t.RATIO_MAP.H265},{code:"30080",msg:"1080P-h264",ratio:t.CLEAR_MAP.V_1080P*t.RATIO_MAP.H264},{code:"30102",msg:"1080PP-h265",ratio:t.CLEAR_MAP.V_1080PP*t.RATIO_MAP.H265},{code:"30112",msg:"1080PP-h264",ratio:t.CLEAR_MAP.V_1080PP*t.RATIO_MAP.H264},{code:"30106",msg:"1080P60-h265",ratio:t.CLEAR_MAP.V_1080P60*t.RATIO_MAP.H265},{code:"30116",msg:"1080P60-h264",ratio:t.CLEAR_MAP.V_1080P60*t.RATIO_MAP.H264}],t.DISTRIBUTION_BASEURL="/data/distribution/"},function(e,t){var r=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,n=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];e.exports=function(e){var t,i,s=e,o=e.indexOf("["),a=e.indexOf("]");-1!=o&&-1!=a&&(e=e.substring(0,o)+e.substring(o,a).replace(/:/g,";")+e.substring(a,e.length));for(var c,d,l=r.exec(e||""),u={},h=14;h--;)u[n[h]]=l[h]||"";return-1!=o&&-1!=a&&(u.source=s,u.host=u.host.substring(1,u.host.length-1).replace(/;/g,":"),u.authority=u.authority.replace("[","").replace("]","").replace(/;/g,":"),u.ipv6uri=!0),u.pathNames=(t=u.path,i=t.replace(/\/{2,9}/g,"/").split("/"),"/"!=t.substr(0,1)&&0!==t.length||i.splice(0,1),"/"==t.substr(t.length-1,1)&&i.splice(i.length-1,1),i),u.queryKey=(c=u.query,d={},c.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,r){t&&(d[t]=r)})),d),u}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Manager=void 0;const n=r(40),i=r(27),s=r(4),o=r(16),a=r(29),c=r(51),d=r(1)("socket.io-client:manager");t.Manager=class extends s{constructor(e,t){super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new c({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const r=t.parser||o;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(d("readyState %s",this._readyState),~this._readyState.indexOf("open"))return this;d("opening %s",this.uri),this.engine=n(this.uri,this.opts);const t=this.engine,r=this;this._readyState="opening",this.skipReconnect=!1;const i=a.on(t,"open",(function(){r.onopen(),e&&e()})),s=a.on(t,"error",t=>{d("error"),r.cleanup(),r._readyState="closed",super.emit("error",t),e?e(t):r.maybeReconnectOnOpen()});if(!1!==this._timeout){const e=this._timeout;d("connect attempt will timeout after %d",e),0===e&&i();const r=setTimeout(()=>{d("connect attempt timed out after %d",e),i(),t.close(),t.emit("error",new Error("timeout"))},e);this.subs.push((function(){clearTimeout(r)}))}return this.subs.push(i),this.subs.push(s),this}connect(e){return this.open(e)}onopen(){d("open"),this.cleanup(),this._readyState="open",super.emit("open");const e=this.engine;this.subs.push(a.on(e,"ping",this.onping.bind(this)),a.on(e,"data",this.ondata.bind(this)),a.on(e,"error",this.onerror.bind(this)),a.on(e,"close",this.onclose.bind(this)),a.on(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){super.emit("ping")}ondata(e){this.decoder.add(e)}ondecoded(e){super.emit("packet",e)}onerror(e){d("error",e),super.emit("error",e)}socket(e,t){let r=this.nsps[e];return r||(r=new i.Socket(this,e,t),this.nsps[e]=r),r}_destroy(e){const t=Object.keys(this.nsps);for(const e of t)if(this.nsps[e].active)return void d("socket %s is still active, skipping close",e);this._close()}_packet(e){d("writing packet %j",e);const t=this.encoder.encode(e);for(let r=0;r<t.length;r++)this.engine.write(t[r],e.options)}cleanup(){d("cleanup"),this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){d("disconnect"),this.skipReconnect=!0,this._reconnecting=!1,"opening"===this._readyState&&this.cleanup(),this.backoff.reset(),this._readyState="closed",this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e){d("onclose"),this.cleanup(),this.backoff.reset(),this._readyState="closed",super.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)d("reconnect failed"),this.backoff.reset(),super.emit("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();d("will wait %dms before reconnect attempt",t),this._reconnecting=!0;const r=setTimeout(()=>{e.skipReconnect||(d("attempting reconnect"),super.emit("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open(t=>{t?(d("reconnect attempt error"),e._reconnecting=!1,e.reconnect(),super.emit("reconnect_error",t)):(d("reconnect success"),e.onreconnect())}))},t);this.subs.push((function(){clearTimeout(r)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),super.emit("reconnect",e)}}},function(e,t,r){const n=r(22),i=r(43),s=r(47),o=r(48);t.polling=function(e){let t,r=!1,o=!1;const a=!1!==e.jsonp;if("undefined"!=typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?443:80),r=e.hostname!==location.hostname||n!==e.port,o=e.secure!==t}if(e.xdomain=r,e.xscheme=o,t=new n(e),"open"in t&&!e.forceJSONP)return new i(e);if(!a)throw new Error("JSONP disabled");return new s(e)},t.websocket=o},function(e,t,r){const n=r(42),i=r(9);e.exports=function(e){const t=e.xdomain,r=e.xscheme,s=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||n))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!r&&s)return new XDomainRequest}catch(e){}if(!t)try{return new(i[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}},function(e,t,r){const n=r(14),i=r(15),s=r(8),o=r(25),a=r(1)("engine.io-client:polling");e.exports=class extends n{get name(){return"polling"}doOpen(){this.poll()}pause(e){const t=this;function r(){a("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){let e=0;this.polling&&(a("we are currently polling - waiting to pause"),e++,this.once("pollComplete",(function(){a("pre-pause polling complete"),--e||r()}))),this.writable||(a("we are currently writing - waiting to pause"),e++,this.once("drain",(function(){a("pre-pause writing complete"),--e||r()})))}else r()}poll(){a("polling"),this.polling=!0,this.doPoll(),this.emit("poll")}onData(e){const t=this;a("polling got data %s",e),s.decodePayload(e,this.socket.binaryType).forEach((function(e,r,n){if("opening"===t.readyState&&"open"===e.type&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():a('ignoring poll - transport state "%s"',this.readyState))}doClose(){const e=this;function t(){a("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(a("transport open - closing"),t()):(a("transport not open - deferring close"),this.once("open",t))}write(e){this.writable=!1,s.encodePayload(e,e=>{this.doWrite(e,()=>{this.writable=!0,this.emit("drain")})})}uri(){let e=this.query||{};const t=this.opts.secure?"https":"http";let r="";return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=o()),this.supportsBinary||e.sid||(e.b64=1),e=i.encode(e),this.opts.port&&("https"===t&&443!==Number(this.opts.port)||"http"===t&&80!==Number(this.opts.port))&&(r=":"+this.opts.port),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+r+this.opts.path+e}}},function(e,t){const r=Object.create(null);r.open="0",r.close="1",r.ping="2",r.pong="3",r.message="4",r.upgrade="5",r.noop="6";const n=Object.create(null);Object.keys(r).forEach(e=>{n[r[e]]=e}),e.exports={PACKET_TYPES:r,PACKET_TYPES_REVERSE:n,ERROR_PACKET:{type:"error",data:"parser error"}}},function(e,t,r){"use strict";var n,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),s={},o=0,a=0;function c(e){var t="";do{t=i[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function d(){var e=c(+new Date);return e!==n?(o=0,n=e):e+"."+c(o++)}for(;a<64;a++)s[i[a]]=a;d.encode=c,d.decode=function(e){var t=0;for(a=0;a<e.length;a++)t=64*t+s[e.charAt(a)];return t},e.exports=d},function(e,t){e.exports.pick=(e,...t)=>t.reduce((t,r)=>(e.hasOwnProperty(r)&&(t[r]=e[r]),t),{})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const n=r(16),i=r(4),s=r(29),o=r(1)("socket.io-client:socket"),a=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});t.Socket=class extends i{constructor(e,t,r){super(),this.receiveBuffer=[],this.sendBuffer=[],this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},r&&r.auth&&(this.auth=r.auth),this.io._autoConnect&&this.open()}subEvents(){if(this.subs)return;const e=this.io;this.subs=[s.on(e,"open",this.onopen.bind(this)),s.on(e,"packet",this.onpacket.bind(this)),s.on(e,"error",this.onerror.bind(this)),s.on(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(a.hasOwnProperty(e))throw new Error('"'+e+'" is a reserved event name');t.unshift(e);const r={type:n.PacketType.EVENT,data:t,options:{}};r.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(o("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),r.id=this.ids++);const i=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return!this.flags.volatile||i&&this.connected?this.connected?this.packet(r):this.sendBuffer.push(r):o("discard packet as the transport is not currently writable"),this.flags={},this}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){o("transport is open - connecting"),"function"==typeof this.auth?this.auth(e=>{this.packet({type:n.PacketType.CONNECT,data:e})}):this.packet({type:n.PacketType.CONNECT,data:this.auth})}onerror(e){this.connected||super.emit("connect_error",e)}onclose(e){o("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,super.emit("disconnect",e)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case n.PacketType.CONNECT:if(e.data&&e.data.sid){const t=e.data.sid;this.onconnect(t)}else super.emit("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case n.PacketType.EVENT:case n.PacketType.BINARY_EVENT:this.onevent(e);break;case n.PacketType.ACK:case n.PacketType.BINARY_ACK:this.onack(e);break;case n.PacketType.DISCONNECT:this.ondisconnect();break;case n.PacketType.CONNECT_ERROR:const t=new Error(e.data.message);t.data=e.data.data,super.emit("connect_error",t)}}onevent(e){const t=e.data||[];o("emitting event %j",t),null!=e.id&&(o("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const r of t)r.apply(this,e)}super.emit.apply(this,e)}ack(e){const t=this;let r=!1;return function(...i){r||(r=!0,o("sending ack %j",i),t.packet({type:n.PacketType.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];"function"==typeof t?(o("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):o("bad ack %s",e.id)}onconnect(e){o("socket connected with id %s",e),this.id=e,this.connected=!0,this.disconnected=!1,super.emit("connect"),this.emitBuffered()}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>this.packet(e)),this.sendBuffer=[]}ondisconnect(){o("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&(o("performing disconnect (%s)",this.nsp),this.packet({type:n.PacketType.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let r=0;r<t.length;r++)if(e===t[r])return t.splice(r,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasBinary=t.isBinary=void 0;const n="function"==typeof ArrayBuffer,i=Object.prototype.toString,s="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===i.call(Blob),o="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===i.call(File);function a(e){return n&&(e instanceof ArrayBuffer||(e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer)(e))||s&&e instanceof Blob||o&&e instanceof File}t.isBinary=a,t.hasBinary=function e(t,r){if(!t||"object"!=typeof t)return!1;if(Array.isArray(t)){for(let r=0,n=t.length;r<n;r++)if(e(t[r]))return!0;return!1}if(a(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return e(t.toJSON(),!0);for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)&&e(t[r]))return!0;return!1}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.on=void 0,t.on=function(e,t,r){return e.on(t,r),function(){e.off(t,r)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCBase=void 0;const n=r(0),i=n.__importDefault(r(5)),s=n.__importDefault(r(3)),o=n.__importDefault(r(13)),a=n.__importDefault(r(2));t.WebRTCBase=class{constructor(e,t,r,n,i){this.isSameIP=!1,this.maxMessageSize=64e3,this.isDestroyed=!1,this.stateRTCStatistic={},this.openTimeoutTime=2e3,this.hasLocalDescription=!1,this.hasRemoteDescription=!1,this.hasReceivedCandidate=!1,this.hasAddCandidateSuccess=!1,this.events=new o.default,this.sdk=e,this.socketController=t,this.cPeerSocketID=r,this.isSameIP=n,this.path=i,this.sdk.state.rtcStatistic||(this.sdk.state.rtcStatistic={}),this.stateRTCStatistic=this.sdk.state.rtcStatistic}init(){var e;this.peerConnection=new RTCPeerConnection({iceServers:[{urls:["stun:web-player-tracker.biliapi.net:3478"]}]}),this.peerConnection.onicecandidate=e=>{var t,r;if(!this.dataChannel||"connecting"===(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))if(e.candidate){if(this.filterIceCandidate(e.candidate))return;let t={type:"candidate",data:JSON.stringify(e.candidate),rid:this.path};null===(r=this.socketController)||void 0===r||r.sendMessage(this.cPeerSocketID,t)}else a.default.getInstance().log(`End of candidates, cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)},null===(e=this.socketController)||void 0===e||e.reportRTCState(this.cPeerSocketID,!0,i.default.RTC_STATE_CODE.INIT)}filterIceCandidate(e){if(this.isSameIP)return!1;try{if("host"===(null==e?void 0:e.type))return!0}catch(e){a.default.getInstance().warn(this.path+" filterIceCandidate filter error: "+e)}return!1}dataChannelRemoveEvent(){this.dataChannel&&(this.dataChannel.onmessage=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null)}on(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,...t){var r;null===(r=this.events)||void 0===r||r.trigger(e,...t)}destroy(){a.default.getInstance().log(`${this.path} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),this.isDestroyed=!0,this.maxMessageSize=64e3,this.leecherGetDataParam=null,this.hasLocalDescription=!1,this.hasRemoteDescription=!1,this.hasReceivedCandidate=!1,this.hasAddCandidateSuccess=!1,this.openTimeoutTimer&&(window.clearTimeout(this.openTimeoutTimer),this.openTimeoutTimer=0),this.stateRTCStatistic={},this.cPeerSocketID="",this.socketController&&(this.socketController.off(s.default.SOCKET_MESSAGE,this.onSocketMessage),this.socketController=null),this.sdk=null,this.dataChannel&&(this.dataChannelRemoveEvent(),this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.ondatachannel=null,this.peerConnection.onicecandidate=null,this.peerConnection.close(),this.peerConnection=null),this.events&&(this.events.destroy(),this.events=null)}onSocketMessage(e){var t,r;if("candidate"===e.type){if("open"===(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))return;this.hasReceivedCandidate=!0;let n=JSON.parse(e.data),i=new RTCIceCandidate(n);null===(r=this.peerConnection)||void 0===r||r.addIceCandidate(i).then(()=>{this.isDestroyed||(this.hasAddCandidateSuccess=!0)},e=>{this.isDestroyed||a.default.getInstance().warn(`${this.path} webRTCController addIceCandidate error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, error: `+e.toString())}).catch(e=>{this.isDestroyed||a.default.getInstance().warn(`${this.path} webRTCController addIceCandidate error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, error: `+e)})}}get dataChannelState(){var e;return null===(e=this.dataChannel)||void 0===e?void 0:e.readyState}getGetDataParam(){return this.leecherGetDataParam}}},function(e,t,r){"use strict";var n=r(6);function i(e,t,r,i,s){var o=n.writeRtpDescription(e.kind,t);if(o+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":s||"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var c="msid:"+(i?i.id:"-")+" "+a+"\r\n";o+="a="+c,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),o}function s(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},i=function(e,t,r,i){var s=n(e.parameters.apt,r),o=n(t.parameters.apt,i);return s&&o&&s.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(n){for(var s=0;s<t.codecs.length;s++){var o=t.codecs[s];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!i(n,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(n.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var i=t.headerExtensions[n];if(e.uri===i.uri){r.headerExtensions.push(i);break}}})),r}function o(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function a(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}e.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function d(t,r,n,i){var s=new Event("track");s.track=r,s.receiver=n,s.transceiver={receiver:n},s.streams=i,e.setTimeout((function(){t._dispatchEvent("track",s)}))}var l=function(r){var i=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){i[e]=s[e].bind(s)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof n;return i&&(n=[n]),n=n.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=i?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var o=r.iceCandidatePoolSize;o>0;o--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=n.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();n.iceTransport=i.iceTransport,n.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(n),n},l.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(n=this.transceivers[i]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},l.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),n.getTracks().forEach((function(e){r.addTrack(e,n)}))}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;i.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},l.prototype._gather=function(t,r){var i=this,s=this.transceivers[r].iceGatherer;if(!s.onlocalcandidate){var o=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),s.onlocalcandidate=function(e){if(!(i.usingBundle&&r>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:r};var a=e.candidate,c=!a||0===Object.keys(a).length;if(c)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),a.component=1,a.ufrag=s.getLocalParameters().usernameFragment;var d=n.writeCandidate(a);o.candidate=Object.assign(o.candidate,n.parseCandidate(d)),o.candidate.candidate=d,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var l=n.getMediaSections(i._localDescription.sdp);l[o.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",i._localDescription.sdp=n.getDescription(i._localDescription.sdp)+l.join("");var u=i.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),c||i._dispatchEvent("icecandidate",o),u&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout((function(){o.forEach((function(e){s.onlocalcandidate(e)}))}),0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:n}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,r,i){var o=s(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:n.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),i&&e.rtpReceiver&&o.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?o.encodings=e.recvEncodingParameters:o.encodings=[{}],o.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(o.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},l.prototype.setLocalDescription=function(e){var t,r,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!o("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)t=n.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=n.parseRtpParameters(e);i.transceivers[t].localCapabilities=r})),i.transceivers.forEach((function(e,t){i._gather(e.mid,t)}));else if("answer"===e.type){t=n.splitSections(i._remoteDescription.sdp),r=t.shift();var a=n.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var o=i.transceivers[t],c=o.iceGatherer,d=o.iceTransport,l=o.dtlsTransport,u=o.localCapabilities,h=o.remoteCapabilities;if(!(n.isRejected(e)&&0===n.matchPrefix(e,"a=bundle-only").length||o.rejected)){var p=n.getIceParameters(e,r),f=n.getDtlsParameters(e,r);a&&(f.role="server"),i.usingBundle&&0!==t||(i._gather(o.mid,t),"new"===d.state&&d.start(c,p,a?"controlling":"controlled"),"new"===l.state&&l.start(f));var m=s(u,h);i._transceive(o,m.codecs.length>0,!1)}}))}return i._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(i){var l=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!o("setRemoteDescription",i.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+l.signalingState));var u={};l.remoteStreams.forEach((function(e){u[e.id]=e}));var h=[],p=n.splitSections(i.sdp),f=p.shift(),m=n.matchPrefix(f,"a=ice-lite").length>0,g=n.matchPrefix(f,"a=group:BUNDLE ").length>0;l.usingBundle=g;var v=n.matchPrefix(f,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!v&&v.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(o,c){var d=n.splitLines(o),p=n.getKind(o),v=n.isRejected(o)&&0===n.matchPrefix(o,"a=bundle-only").length,y=d[0].substr(2).split(" ")[2],C=n.getDirection(o,f),R=n.parseMsid(o),b=n.getMid(o)||n.generateIdentifier();if(v||"application"===p&&("DTLS/SCTP"===y||"UDP/DTLS/SCTP"===y))l.transceivers[c]={mid:b,kind:p,protocol:y,rejected:!0};else{var T,S,_,P,D,k,E,w,I;!v&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(p,!0));var O,A,N=n.parseRtpParameters(o);v||(O=n.getIceParameters(o,f),(A=n.getDtlsParameters(o,f)).role="client"),E=n.parseRtpEncodingParameters(o);var x=n.parseRtcpParameters(o),B=n.matchPrefix(o,"a=end-of-candidates",f).length>0,M=n.matchPrefix(o,"a=candidate:").map((function(e){return n.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===i.type||"answer"===i.type)&&!v&&g&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==i.type||v)"answer"!==i.type||v||(S=(T=l.transceivers[c]).iceGatherer,_=T.iceTransport,P=T.dtlsTransport,D=T.rtpReceiver,k=T.sendEncodingParameters,w=T.localCapabilities,l.transceivers[c].recvEncodingParameters=E,l.transceivers[c].remoteCapabilities=N,l.transceivers[c].rtcpParameters=x,M.length&&"new"===_.state&&(!m&&!B||g&&0!==c?M.forEach((function(e){a(T.iceTransport,e)})):_.setRemoteCandidates(M)),g&&0!==c||("new"===_.state&&_.start(S,O,"controlling"),"new"===P.state&&P.start(A)),!s(T.localCapabilities,T.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&T.sendEncodingParameters[0].rtx&&delete T.sendEncodingParameters[0].rtx,l._transceive(T,"sendrecv"===C||"recvonly"===C,"sendrecv"===C||"sendonly"===C),!D||"sendrecv"!==C&&"sendonly"!==C?delete T.rtpReceiver:(I=D.track,R?(u[R.stream]||(u[R.stream]=new e.MediaStream),r(I,u[R.stream]),h.push([I,D,u[R.stream]])):(u.default||(u.default=new e.MediaStream),r(I,u.default),h.push([I,D,u.default]))));else{(T=l.transceivers[c]||l._createTransceiver(p)).mid=b,T.iceGatherer||(T.iceGatherer=l._createIceGatherer(c,g)),M.length&&"new"===T.iceTransport.state&&(!B||g&&0!==c?M.forEach((function(e){a(T.iceTransport,e)})):T.iceTransport.setRemoteCandidates(M)),w=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(w.codecs=w.codecs.filter((function(e){return"rtx"!==e.name}))),k=T.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var j,L=!1;"sendrecv"===C||"sendonly"===C?(L=!T.rtpReceiver,D=T.rtpReceiver||new e.RTCRtpReceiver(T.dtlsTransport,p),L&&(I=D.track,R&&"-"===R.stream||(R?(u[R.stream]||(u[R.stream]=new e.MediaStream,Object.defineProperty(u[R.stream],"id",{get:function(){return R.stream}})),Object.defineProperty(I,"id",{get:function(){return R.track}}),j=u[R.stream]):(u.default||(u.default=new e.MediaStream),j=u.default)),j&&(r(I,j),T.associatedRemoteMediaStreams.push(j)),h.push([I,D,j]))):T.rtpReceiver&&T.rtpReceiver.track&&(T.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===T.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),T.associatedRemoteMediaStreams=[]),T.localCapabilities=w,T.remoteCapabilities=N,T.rtpReceiver=D,T.rtcpParameters=x,T.sendEncodingParameters=k,T.recvEncodingParameters=E,l._transceive(l.transceivers[c],!1,L)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===i.type?"active":"passive"),l._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(u).forEach((function(t){var r=u[t];if(r.getTracks().length){if(-1===l.remoteStreams.indexOf(r)){l.remoteStreams.push(r);var n=new Event("addstream");n.stream=r,e.setTimeout((function(){l._dispatchEvent("addstream",n)}))}h.forEach((function(e){var t=e[0],n=e[1];r.id===e[2].id&&d(l,t,n,[r])}))}})),h.forEach((function(e){e[2]||d(l,e[0],e[1],[])})),e.setTimeout((function(){l&&l.transceivers&&l.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},l.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var s=r.transceivers.filter((function(e){return"audio"===e.kind})).length,o=r.transceivers.filter((function(e){return"video"===e.kind})).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(s=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(o=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--s<0&&(e.wantReceive=!1):"video"===e.kind&&--o<0&&(e.wantReceive=!1)}));s>0||o>0;)s>0&&(r._createTransceiver("audio"),s--),o>0&&(r._createTransceiver("video"),o--);var d=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(i,s){var o=i.track,a=i.kind,c=i.mid||n.generateIdentifier();i.mid=c,i.iceGatherer||(i.iceGatherer=r._createIceGatherer(s,r.usingBundle));var d=e.RTCRtpSender.getCapabilities(a);t<15019&&(d.codecs=d.codecs.filter((function(e){return"rtx"!==e.name}))),d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),d.headerExtensions.forEach((function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var l=i.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];o&&t>=15019&&"video"===a&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,a)),i.localCapabilities=d,i.sendEncodingParameters=l})),"max-compat"!==r._config.bundlePolicy&&(d+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){d+=i(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,d+="a="+n.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))}));var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var o=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(o+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n";var a=n.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,n){if(!(n+1>a)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?o+="m=application 0 DTLS/SCTP 5000\r\n":o+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var d=s(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=i(e,d,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}}));var d=new e.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(i,s){if(!r._remoteDescription)return s(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<r.transceivers.length;d++)if(r.transceivers[d].mid===e.sdpMid){o=d;break}var l=r.transceivers[o];if(!l)return s(c("OperationError","Can not add ICE candidate"));if(l.rejected)return i();var u=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return i();if(u.component&&1!==u.component)return i();if((0===o||o>0&&l.iceTransport!==r.transceivers[0].iceTransport)&&!a(l.iceTransport,u))return s(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=n.getMediaSections(r._remoteDescription.sdp))[o]+="a="+(u.type?h:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var p=0;p<r.transceivers.length&&(r.transceivers[p].rejected||(r.transceivers[p].iceTransport.addRemoteCandidate({}),(t=n.getMediaSections(r._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));p++);i()}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats())}))})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r])})),t}))}}}));var u=["createOffer","createAnswer"];return u.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),l}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0);r(60),r(59);const i=n.__importDefault(r(33)),s=n.__importDefault(r(11)),o=n.__importDefault(r(7)),a=n.__importDefault(r(12)),c=n.__importDefault(r(3)),d=n.__importDefault(r(5)),l=n.__importStar(r(2));class u{constructor(e){this.enterReportTimer=0,this.saveDataBuvidSwitch=!1,this.disableSaveDataByDB=!1,this.disableGetData=!0,this.saveAndGetDataSwitch=!1,this.trackerVersion="",this.init(e)}get version(){return"bp-nc-sdk "+o.default.getInstance().version}get saveDataEnabled(){return this.saveAndGetDataSwitch&&this.saveDataBuvidSwitch&&!this.disableSaveDataByDB}get getDataEnabled(){return this.saveAndGetDataSwitch&&!this.disableGetData}init(e){this.config={aid:0,cid:0,bvid:""},e&&(this.config.aid=Math.floor(e.aid),this.config.cid=Math.floor(e.cid),this.config.bvid=e.bvid?""+e.bvid:"",e.buvid?this.config.buvid=""+e.buvid:this.config.buvid=s.default.getCookie("buvid3"),!0===e.isAdmin&&(this.config.isAdmin=!0),e.debugKey&&(this.config.debugKey=""+e.debugKey)),this.state={},l.default.getInstance().log(`init -- version: ${o.default.getInstance().version}, isSupportNC: ${s.default.isSupportP2P()}`),this.eventBus=a.default.getInstance(),s.default.isSupportP2P()&&(this.main=new i.default(this)),this.enterReportTimer=window.setTimeout(()=>{let e={type:d.default.TRACK_TYPE.ENTER,version:o.default.getInstance().version,isSupportP2P:s.default.isSupportP2P()};this.trigger(c.default.TRACK,e)})}updateConfig(e){e&&(this.config={aid:0,cid:0,bvid:""},this.config.aid=Math.floor(e.aid),this.config.cid=Math.floor(e.cid),this.config.bvid=e.bvid?""+e.bvid:"",e.buvid&&(this.config.buvid=""+e.buvid),!0===e.isAdmin&&(this.config.isAdmin=!0),e.debugKey&&(this.config.debugKey=""+e.debugKey))}quit(){let e={type:d.default.TRACK_TYPE.QUIT,version:o.default.getInstance().version};this.state.getData&&(e.getData=this.state.getData),this.state.rtcStatistic&&(e.rtcStatistic=this.state.rtcStatistic),this.state.dbStatistic&&(e.dbStatistic=this.state.dbStatistic),this.trigger(c.default.TRACK,e)}destroy(){l.default.getInstance().log("destroy"),window.clearTimeout(this.enterReportTimer),this.main&&(this.main.destroy(),this.main=null),this.eventBus&&(this.eventBus.destroy(),this.eventBus=null),this.saveAndGetDataSwitch=!1,this.saveDataBuvidSwitch=!1,this.disableSaveDataByDB=!1,l.default.getInstance().reset(),this.state={}}getData(e){if(s.default.isSupportP2P()&&this.main&&e&&this.getDataEnabled){let t=`\n            ----\n            getData -- url: ${e.url}, range: ${e.range}`;return l.default.getInstance().log(t),e.startTime=Date.now(),this.main.getData(e,!0)}return Promise.reject({code:-1,msg:"basic error"})}getDBAllResource(){return this.main?this.main.getDBAllResource():Promise.reject({code:-1,msg:"no main class"})}saveData(e){var t;if(s.default.isSupportP2P()&&this.main&&e&&this.saveDataEnabled){let r=`saveData -- url: ${e.url}, range: ${e.range}, totalSize: ${e.totalSize}, `;r+="dataSize: "+(null===(t=e.data)||void 0===t?void 0:t.byteLength),l.default.getInstance().log(r),this.main.saveData(e)}}abortGetData(e){s.default.isSupportP2P()&&this.main&&e&&"string"==typeof e&&this.main.abortGetData(e)}getToken(){return s.default.randomString(16)}allowDPGetDataByNC(e){if(!this.getDataEnabled)return!1;if(!e)return!1;const t=+e.rangeStart,r=Math.floor(e.qn),n=+e.bufferLevel;return!(isNaN(t)||t<100||isNaN(r)||r<=0||!(r>3e4&&r<=30116||r>30200&&r<=30280)||isNaN(n)||n<10)}getLogHistory(e=l.LOG_LEVEL.INFO){return l.default.getInstance().getHistory(e)}one(e,t){var r;null===(r=this.eventBus)||void 0===r||r.one(e,t)}on(e,t){var r;null===(r=this.eventBus)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.eventBus)||void 0===r||r.off(e,t)}trigger(e,t){var r;null===(r=this.eventBus)||void 0===r||r.trigger(e,t)}}u.LOG_LEVEL=l.LOG_LEVEL,u.BPP2PEvent=c.default,u.isSupport=s.default.isSupportP2P,t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(10)),s=n.__importDefault(r(11)),o=n.__importDefault(r(34)),a=n.__importDefault(r(7)),c=n.__importDefault(r(12)),d=n.__importDefault(r(3)),l=n.__importDefault(r(5)),u=n.__importDefault(r(2)),h=n.__importDefault(r(35)),p=n.__importDefault(r(56)),f=r(58);class m{constructor(e){this.onceSaveDataSizeMax=52428800,this.needSaveDataSizeMax=157286400,this.needSaveDataNumMax=4,this.isReportedSaveData=!1,this.refreshTimeout=5e4,this.getDataFromP2PTimeout=5e3,this.getDataFromDBTimeout=1e3,this.stateGetData={},this.sdk=e,this.needSaveResources={},this.webRTCSeeders=[],this.useP2PGetDataObj={},this.useDBGetDataObjArr=[],this.sdk.state.getData||(this.sdk.state.getData={}),this.stateGetData=this.sdk.state.getData,this.socketController=new h.default(this.sdk),this.socketController.on(d.default.SOCKET_MESSAGE,this.onSocketMessage),this.dbController=new o.default(this.sdk,this.socketController),this.webrtcWorkshop=new p.default(this.sdk,this.socketController)}onSocketMessage(e){if(e&&e.fromSocketID&&e.rid)if("offer"===e.type){if(!e.data)return;const t=new f.WebRTCSeeder(this.sdk,this.socketController,e.fromSocketID,Boolean(e.isSameIP),""+e.rid);t.on(d.default.WEBRTC_ANSWER_TIMEOUT,this.onWebRTCAnswerTimeout),t.createAnswer(e.data),this.webRTCSeeders.push(t),this.webRTCSeeders.length>1&&u.default.getInstance().warn(`answer webRTCSeeders more than 1 -- length: ${this.webRTCSeeders.length}, fromSocketID: ${e.fromSocketID}`)}else"released"===e.type&&this.releasedBySocket(e.fromSocketID,e.rid)}onWebRTCAnswerTimeout(e,t,r){this.releasedBySocket(e,t)}getDBAllResource(){return this.dbController?this.dbController.getDBAllResource():Promise.reject({code:4021,msg:"no dbController"})}destroy(){var e,t,r,n;clearTimeout(this.refreshTimer),null===(e=this.socketController)||void 0===e||e.off(d.default.SOCKET_MESSAGE),null===(t=this.webrtcWorkshop)||void 0===t||t.destroy(),null===(r=this.dbController)||void 0===r||r.destroy(),null===(n=this.socketController)||void 0===n||n.destroy(),delete this.isReportedSaveData,delete this.needSaveResources,delete this.stateGetData,delete this.dbController,delete this.socketController,delete this.webrtcWorkshop,delete this.refreshTimer;for(let e=0;e<this.webRTCSeeders.length;e++){let t=this.webRTCSeeders[e];t&&t.destroy()}this.webRTCSeeders=[];for(const e in this.useP2PGetDataObj)for(let t=0;t<this.useP2PGetDataObj[e].length;t++)this.clearGetDataObj(this.useP2PGetDataObj[e][t],!1,!0);this.useP2PGetDataObj={};for(let e=0;e<this.useDBGetDataObjArr.length;e++)this.clearGetDataObj(this.useDBGetDataObjArr[e],!1,!0);this.useDBGetDataObjArr=[]}saveData(e){var t;if(!this.isReportedSaveData){this.isReportedSaveData=!0;let t={type:l.default.TRACK_TYPE.SAVE_DATA,version:a.default.getInstance().version,url:e.url,range:e.range,resourceTotalSize:e.totalSize};c.default.getInstance().trigger(d.default.TRACK,t)}let r=this.handleDataParam("save",e);if(!r)return;if(r.data.byteLength>this.onceSaveDataSizeMax)return void u.default.getInstance().warn("more than onceSaveDataSizeMax -- dataSize: "+r.data.byteLength);let n=0;for(let e in this.needSaveResources)this.needSaveResources[e]&&this.needSaveResources[e].blockNum&&(n+=this.needSaveResources[e].blockNum);if(1024*n*1024>this.needSaveDataSizeMax)return void u.default.getInstance().warn("more than needSaveDataSizeMax -- needSaveBlockNum: "+n);this.blockData(r),this.needSaveResources[r.path].updateTime=(new Date).getTime();let i=0,s="";for(let e in this.needSaveResources)this.needSaveResources[e]?(i++,s?this.needSaveResources[e].updateTime<this.needSaveResources[s].updateTime&&(s=e):s=e):delete this.needSaveResources[e];s&&i>this.needSaveDataNumMax&&(this.needSaveResources[s]=null,delete this.needSaveResources[s]);let o=!1;for(let e in this.needSaveResources)if(this.needSaveResources[e]&&this.needSaveResources[e].blockNum){o=!0;break}o&&(null===(t=this.dbController)||void 0===t||t.saveResource(this.needSaveResources))}abortGetData(e){for(const t in this.useP2PGetDataObj)for(let r=0;r<this.useP2PGetDataObj[t].length;r++){const n=this.useP2PGetDataObj[t][r];if(n&&n.token&&n.token===e){let e=!1;0===r&&(e=!0),u.default.getInstance().log("abortGetData i:",r,n.internalParam),this.removeGetDataObj(n,e);break}}}getData(e,t=!1){var r;let n=this.handleDataParam("get",e);if(!n)return Promise.reject({code:4e3,msg:"data param invalid",reponseData:{path:null==n?void 0:n.path,range:(null==n?void 0:n.rangeStart)+"-"+(null==n?void 0:n.rangeEnd)}});if(t&&(null===(r=this.socketController)||void 0===r?void 0:r.noPeerRecord)){const e=this.socketController.noPeerRecord[n.path];if(null==e?void 0:e.disableNCTimer)return Promise.reject({code:4022,msg:"current resource has no peer for several times, disable getData",responseData:{path:n.path,range:(null==n?void 0:n.rangeStart)+"-"+(null==n?void 0:n.rangeEnd)}})}let i={useP2P:t,token:e.token,dataParam:e,internalParam:n},s=this.getDataFromDBTimeout;i.useP2P&&(this.stateGetData.useP2P=this.stateGetData.useP2P?this.stateGetData.useP2P+1:1,s=this.getDataFromP2PTimeout);const{path:o}=n;return i.promise=new Promise((e,t)=>{i.onResolve=e,i.onReject=t}),this.useP2PGetDataObj[o]=i.useP2P?[...this.useP2PGetDataObj[o]||[],i]:this.useDBGetDataObjArr,this.useP2PGetDataObj[o].length>1?(u.default.getInstance().log("wait for getting video data, getDataObjArr.length:",this.useP2PGetDataObj[o].length),i.promise):(this.internalGetData(this.useP2PGetDataObj[o][0]),i.promise)}internalGetData(e){var t;return n.__awaiter(this,void 0,void 0,(function*(){if(u.default.getInstance().log(e.internalParam.path+" internalGetData",e),e.useP2P){Math.floor(e.internalParam.rangeStart/a.default.BLOCK_SIZE),Math.floor(e.internalParam.rangeEnd/a.default.BLOCK_SIZE);const{path:t}=e.internalParam;if(clearTimeout(this.refreshTimer),this.refreshTimer=setTimeout(()=>{var r,n,i,s;const o={range:(null===(r=e.internalParam)||void 0===r?void 0:r.rangeStart)+"-"+(null===(n=e.internalParam)||void 0===n?void 0:n.rangeEnd),from:0,path:null===(i=e.internalParam)||void 0===i?void 0:i.path,getDataTime:Date.now()-(null===(s=e.internalParam)||void 0===s?void 0:s.startTime),data:void 0,gotDataByte:0,rtcDataChannelState:void 0,cPeerSID:""};e.onReject&&e.onReject({code:4005,msg:`current ${t} peer lose`,responseData:o}),this.removeGetDataObj(e,!1)},this.refreshTimeout),this.socketController)try{const{path:t,rangeStart:r,rangeEnd:n,token:i,bitrate:s,latency:o}=e.internalParam,a=yield this.webrtcWorkshop.getData(t,{start:r,end:n},i,s,o);u.default.getInstance().log(t+" rtcResolveRes",a),e.onResolve&&e.onResolve(a),this.removeGetDataObj(e,!0,!1),this.stateGetData.useP2PSuccess=this.stateGetData.useP2PSuccess?this.stateGetData.useP2PSuccess+1:1}catch(r){u.default.getInstance().log(t+" rtcRejectRes",r),e.onReject&&e.onReject(r),this.removeGetDataObj(e,!0);const n=null==r?void 0:r.code;4020===n?this.stateGetData.useP2PFileReaderError=++this.stateGetData.useP2PFileReaderError||1:4007===n?this.stateGetData.useP2PWebRTCOpenTimeout=++this.stateGetData.useP2PWebRTCOpenTimeout||1:4008===n?this.stateGetData.useP2PWebRTCOpenTimeoutByNoLDP=++this.stateGetData.useP2PWebRTCOpenTimeoutByNoLDP||1:4009===n?this.stateGetData.useP2PWebRTCOpenTimeoutByNoRDP=++this.stateGetData.useP2PWebRTCOpenTimeoutByNoRDP||1:4010===n?this.stateGetData.useP2PWebRTCOpenTimeoutByNoRC=++this.stateGetData.useP2PWebRTCOpenTimeoutByNoRC||1:4011===n?this.stateGetData.useP2PWebRTCOpenTimeoutByNoACS=++this.stateGetData.useP2PWebRTCOpenTimeoutByNoACS||1:this.stateGetData.useP2PWebRTCFail=++this.stateGetData.useP2PWebRTCFail||1}else e.onReject&&e.onReject({code:4002,msg:"no socketController"}),this.removeGetDataObj(e,!0),this.stateGetData.useP2PNoSCFail=this.stateGetData.useP2PNoSCFail?this.stateGetData.useP2PNoSCFail+1:1}else null===(t=this.dbController)||void 0===t||t.getResource(e.internalParam).then(t=>{e.onResolve&&e.onResolve(t),this.removeGetDataObj(e,!0)},t=>{e.onReject&&e.onReject(t),this.removeGetDataObj(e,!0)})}))}clearGetDataObj(e,t=!0,r=!1){e&&(e.onResolve=null,e.onReject=null,e.promise=null)}removeGetDataObj(e,t=!1,r=!0,n=!1){if(!e)return;let i;this.clearGetDataObj(e,r,n),i=e.useP2P?this.useP2PGetDataObj[e.internalParam.path]||[]:this.useDBGetDataObjArr;let s=-1;for(let t=0;t<i.length;t++)if(i[t]===e){i.splice(t,1),s=t;break}i.length&&(0===s&&t?this.internalGetData(i[0]):u.default.getInstance().warn("removeGetDataObj is not first and need getNextData -- removeI: ' + "+s))}releasedBySocket(e,t){if(e)for(let r=0;r<this.webRTCSeeders.length;r++){let n=this.webRTCSeeders[r];if(n&&n.cPeerSocketID===e)if(t){if(t===n.path){this.removeWebRTCSeeder(n,r);break}}else this.removeWebRTCSeeder(n,r)}}removeWebRTCSeeder(e,t){var r;if(e){if(null===(r=e.getGetDataParam())||void 0===r?void 0:r.token)for(let t=0;t<this.useDBGetDataObjArr.length;t++)if(this.useDBGetDataObjArr[t].token===e.getGetDataParam().token){let e=!1;0===t&&(e=!0),this.removeGetDataObj(this.useDBGetDataObjArr[t],e);break}e.off(d.default.WEBRTC_ANSWER_TIMEOUT),e.destroy(),this.webRTCSeeders.splice(t,1)}}handleDataParam(e,t){if(!t||!t.url)return null;let r=""+t.url,n=r.split("?")[0].split("/"),i=n[n.length-1];if(!i)return null;let s=(""+t.range).split("-");if(s.length<2)return null;let o=parseInt(s[0],10),a=parseInt(s[1],10);if(isNaN(o)||isNaN(a)||o<0||a<o)return null;if(!t.token||"string"!=typeof t.token)return u.default.getInstance().log("no valid token"),null;if(t.totalSize&&a>=t.totalSize)return u.default.getInstance().log("要获取的数据范围超出资源最大字节范围"),null;let c=t.data;return"save"!==e||c&&c.byteLength&&c.byteLength===a-o+1?{type:e,url:r,path:i,rangeStart:o,rangeEnd:a,token:t.token,startTime:t.startTime,data:c,totalSize:t.totalSize,bitrate:t.bitrate,latency:t.latency}:null}blockData(e){let t=e.path,r=e.rangeStart,n=e.rangeEnd,i=e.data;this.needSaveResources[t]||(this.needSaveResources[t]={id:t,blocks:[],blockNum:0,priority:-1,updateTime:0});let o=this.needSaveResources[t],c=o.waitConcatData;c&&c.rangeEnd===r-1&&(r=c.rangeStart,i=s.default.concatArrayBuffer(c.data,i),o.waitConcatData=c=null),e.totalSize&&!o.totalSize&&(o.totalSize=e.totalSize),o.blocks||(o.blocks=[]);const d=Math.ceil(r/a.default.BLOCK_SIZE),l=Math.floor(n/a.default.BLOCK_SIZE);u.default.getInstance().log(`blockData -- startIndex: ${d}, endIndex: ${l}`);for(let e=d;e<l;e++)o.blocks[e]||(o.blocks[e]={id:e,data:new Blob([i.slice(e*a.default.BLOCK_SIZE-r,(e+1)*a.default.BLOCK_SIZE-r)],{type:"multipart/byteranges"}),priority:-1,isLast:!1},o.blockNum++);if(n>=l*a.default.BLOCK_SIZE&&!o.blocks[l]){let s=r>l*a.default.BLOCK_SIZE?r:l*a.default.BLOCK_SIZE;e.totalSize&&n===e.totalSize-1&&s===l*a.default.BLOCK_SIZE||n===(l+1)*a.default.BLOCK_SIZE-1&&s===l*a.default.BLOCK_SIZE?(o.blocks[l]={id:l,data:new Blob([i.slice(s-r,n+1-r)],{type:"multipart/byteranges"}),priority:-1,isLast:!1},e.totalSize&&n===e.totalSize-1&&(o.blocks[l].isLast=!0),o.blockNum++):(o.waitConcatData={type:e.type,url:e.url,path:t,rangeStart:s,rangeEnd:n,token:e.token,data:i.slice(s-r,n+1-r)},e.totalSize&&(o.waitConcatData.totalSize=e.totalSize))}u.default.getInstance().log("this.needSaveResources",this.needSaveResources)}getNodeVar(e,t){this.socketController&&this.socketController.getNodeVar(e,t)}hotPushToTracker(e,t){var r;e&&t?null===(r=this.socketController)||void 0===r||r.hotPushToTracker(e,t):u.default.getInstance().log("hotPushToTracker -- param invalid")}}n.__decorate([i.default],m.prototype,"onSocketMessage",null),n.__decorate([i.default],m.prototype,"onWebRTCAnswerTimeout",null),t.default=m},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(10)),s=n.__importDefault(r(7)),o=n.__importDefault(r(12)),a=n.__importDefault(r(3)),c=n.__importDefault(r(5)),d=n.__importDefault(r(2));class l{constructor(e,t){this.dbName="bilibiliPlayerCacheData",this.dbVersion=1,this.isOpeningDB=!1,this.isSavingResource=!1,this.objectStoreName="resource",this.resourceMaxNum=20,this.resourceMaxSize=524288e3,this.resourceUpdateInterval=864e5,this.isReportedPutDB=!1,this.isReportedDelDBErr=!1,this.openDBErrNum=0,this.openDBErrMaxNum=10,this.stateDBStatistic={},this.needSaveResources={},this.sdk=e,this.socketController=t,this.sdk.state.dbStatistic||(this.sdk.state.dbStatistic={}),this.stateDBStatistic=this.sdk.state.dbStatistic}destroy(){this.socketController&&(this.socketController.off(a.default.SOCKET_CONNECT,this.onSocketConnect),this.socketController=null),this.isReportedPutDB=!1,this.needSaveResources={},this.stateDBStatistic={},this.dbClose(),this.isOpeningDB=!1,this.isSavingResource=!1,this.openDBErrNum=0,this.isReportedDelDBErr=!1}onSocketConnect(){this.getDBAllResource().then(e=>{var t,r,n,i;let s=[];if(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.length)for(let t=0;t<e.data.length;t++)if(null===(n=null===(r=e.data[t])||void 0===r?void 0:r.blocks)||void 0===n?void 0:n.length){const r=e.data[t];let n={id:r.id,blockIDs:[]};for(let e=0;e<r.blocks.length;e++)r.blocks[e]&&n.blockIDs.push(e);n.id&&n.blockIDs.length&&s.push(n)}s.length&&(null===(i=this.socketController)||void 0===i||i.report(c.default.RESOURCE_OPTION.UPDATE,s))},e=>{})}saveResource(e){if(e&&!this.isSavingResource)if(this.isSavingResource=!0,this.needSaveResources=e,this.db)this.checkAndWriteDBData().then(()=>{this.delayOpenSaveResource()},()=>{this.delayOpenSaveResource()});else{if(this.isOpeningDB)return d.default.getInstance().log("saveResource isOpeningDB"),void(this.isSavingResource=!1);this.openDB().then(()=>{this.checkAndWriteDBData().then(()=>{this.delayOpenSaveResource()},()=>{this.delayOpenSaveResource()})},()=>{this.delayOpenSaveResource()})}}delayOpenSaveResource(){window.setTimeout(()=>{this.isSavingResource=!1},200)}checkAndWriteDBData(){let e,t;const r=new Promise((r,n)=>{e=r,t=n});return this.db.objectStoreNames.contains(this.objectStoreName)?this.writeDBData():(this.dbClose(),this.openDB(this.dbVersion+1).then(()=>{this.writeDBData().then(()=>{e({code:1,msg:"save data success"})},()=>{t({code:-1,msg:"save data fail"})})},()=>{t({code:-1,msg:"save data fail"})}),r)}getResource(e){let t,r;const n=new Promise((e,n)=>{t=e,r=n});return this.db?this.readDBData(e):this.isOpeningDB?(d.default.getInstance().log("getResource isOpeningDB"),r({code:-1,msg:"db is opening"}),n):(this.openDB().then(()=>{this.readDBData(e).then(e=>{t(e)},e=>{r(e)})},()=>{}),n)}getDBAllResource(){let e,t;const r=new Promise((r,n)=>{e=r,t=n});return this.db?this.readDBAllData():this.isOpeningDB?(d.default.getInstance().log("getDBAllResource isOpeningDB"),t({code:-1,msg:"db is opening"}),r):(this.openDB().then(()=>{this.readDBAllData().then(t=>{e(t)},e=>{t(e)})},()=>{}),r)}readDBAllData(){let e,t;const r=new Promise((r,n)=>{e=r,t=n});if(!this.db.objectStoreNames.contains(this.objectStoreName))return t({code:-1,msg:"db not contains objectStoreName"}),r;const n=this.db.transaction([this.objectStoreName]).objectStore(this.objectStoreName).openCursor(null,"prev");let i=[];return n.onsuccess=()=>{const t=n.result;if(t){if(t.value&&t.value.resource){let e=t.value.resource;if(e.blocks&&e.blocks.length)for(let t=0;t<e.blocks.length;t++)e.blocks[t]&&(e.blocks[t].data=void 0);i.push(e)}t.continue()}else e({code:1,msg:"success",data:i})},n.onerror=e=>{d.default.getInstance().log("readDBAllData cursorObjectStoreRequest error: "+e),t({code:-1,msg:"readDBAllData cursorObjectStoreRequest error"})},r}readDBData(e){let t,r;const n=new Promise((e,n)=>{t=e,r=n});if(!this.db.objectStoreNames.contains(this.objectStoreName))return r({code:-1,msg:"db not contains objectStoreName"}),n;let i=e.path,o=e.rangeStart,a=e.rangeEnd;const c=e.startTime,l=this.db.transaction([this.objectStoreName]).objectStore(this.objectStoreName);d.default.getInstance().log("read db get data -- path: "+i);const u=l.get(i);return u.onsuccess=e=>{var n,l;let h;if(d.default.getInstance().log(`read db get data success -- path: ${i}, blockNum: ${null===(l=null===(n=u.result)||void 0===n?void 0:n.resource)||void 0===l?void 0:l.blockNum}`),u.result&&(h=u.result.resource),!(h&&h.blocks&&h.blocks.length))return d.default.getInstance().log("数据不存在，获取数据失败！"),void r({code:-1,msg:"data not enough"});{const e=Math.floor(o/s.default.BLOCK_SIZE),n=Math.floor(a/s.default.BLOCK_SIZE);let l=[],u=null;for(let t=e;t<=n;t++){if(!h.blocks[t]||!h.blocks[t].data)return d.default.getInstance().log("数据不足，获取数据失败！"),void r({code:-1,msg:"data not enough"});l.push(h.blocks[t].data)}if(!l.length||l.length!==n-e+1)return d.default.getInstance().log("22数据不足，获取数据失败！"),void r({code:-1,msg:"data not enough"});{let h;e===n?l[0]=l[0].slice(o%s.default.BLOCK_SIZE,a%s.default.BLOCK_SIZE+1,"multipart/byteranges"):(l[0]=l[0].slice(o%s.default.BLOCK_SIZE,l[0].size,"multipart/byteranges"),l[l.length-1]=l[l.length-1].slice(0,a%s.default.BLOCK_SIZE+1,"multipart/byteranges")),u=new Blob(l,{type:"multipart/byteranges"});let p=new FileReader;p.onload=e=>{if(h=e.target.result,!h||!h.byteLength||h.byteLength!==a-o+1)return d.default.getInstance().log("33数据不足，获取数据失败！"),void r({code:-1,msg:"data not enough"});{let e={range:o+"-"+a,from:1,path:i,getDataTime:Date.now()-c,data:h,gotDataByte:h.byteLength,cPeerSID:""};d.default.getInstance().log("取得数据，",e),t({code:1,msg:"success",responseData:e})}},p.onerror=e=>{p.onerror=null,p.onload=null,r({code:4020,msg:"read db fileReader error"});let t="";e&&e.target&&e.target.error&&(t=e.target.error.message||""),d.default.getInstance().error(`read db fileReader error -- path: ${i}, errorMessage: ${t}`),this.stateDBStatistic.fileReaderError=this.stateDBStatistic.fileReaderError?this.stateDBStatistic.fileReaderError+1:1},p.readAsArrayBuffer(u)}}},u.onerror=e=>{let t="";e&&e.target&&e.target.error&&(t=e.target.error.message||""),d.default.getInstance().error(`read db get data error -- path: ${i}, errorMessage: ${t}`),r({code:-1,msg:"get ObjectStoreRequest error"})},n}openDB(e=0){let t={type:c.default.TRACK_TYPE.OPEN_DB,version:s.default.getInstance().version,dbVersion:this.dbVersion,openVersion:e,dbName:this.dbName};o.default.getInstance().trigger(a.default.TRACK,t),d.default.getInstance().log(`openDB -- dbVersion: ${this.dbVersion}, openVersion: ${e}`),this.isOpeningDB=!0;let r,n=null,i=null,l=new Promise((e,t)=>{n=e,i=t});return r=e>0?window.indexedDB.open(this.dbName,e):window.indexedDB.open(this.dbName),r.onupgradeneeded=e=>{d.default.getInstance().log("db onupgradeneeded");const t=r.result;if(!t.objectStoreNames.contains(this.objectStoreName)){let e;e=t.createObjectStore(this.objectStoreName,{keyPath:"id"}),e.createIndex("id","id",{unique:!0}),e.createIndex("resource","resource",{unique:!1})}},r.onerror=t=>{this.isOpeningDB=!1,this.openDBErrNum++,this.openDBErrNum>=this.openDBErrMaxNum&&(this.sdk.disableSaveDataByDB=!0);let r={type:c.default.TRACK_TYPE.OPEN_DB_ERROR,version:s.default.getInstance().version,dbVersion:this.dbVersion,openVersion:e,dbName:this.dbName,errorName:"",errorMessage:""};if(t&&t.target&&t.target.error){const e=t.target.error;r.errorName=e.name||"",r.errorMessage=e.message||""}o.default.getInstance().trigger(a.default.TRACK,r),d.default.getInstance().error("openDB error -- errorMessage: "+r.errorMessage),i()},r.onsuccess=t=>{if(this.isOpeningDB=!1,this.dbVersion=r.result.version,this.db=r.result,e>0&&!this.db.objectStoreNames.contains(this.objectStoreName)){this.dbClose(),this.openDBErrNum++,this.openDBErrNum>=this.openDBErrMaxNum&&(this.sdk.disableSaveDataByDB=!0);let t={type:c.default.TRACK_TYPE.OPEN_DB_ERROR,version:s.default.getInstance().version,dbVersion:this.dbVersion,openVersion:e,dbName:this.dbName,errorName:"noObjectStoreName",errorMessage:"no objectStoreName"};return o.default.getInstance().trigger(a.default.TRACK,t),d.default.getInstance().error("openDB error -- errorMessage: "+t.errorMessage),void i()}this.openDBErrNum=0,this.db.onclose=t=>{let r={type:c.default.TRACK_TYPE.DB_CLOSE,version:s.default.getInstance().version,dbVersion:this.dbVersion,openVersion:e,dbName:this.dbName};o.default.getInstance().trigger(a.default.TRACK,r),d.default.getInstance().log("db onclose"),this.dbClose()},d.default.getInstance().log("openDB success -- dbVersion: "+this.dbVersion),n()},l}writeDBData(){let e,t;const r=new Promise((r,n)=>{e=r,t=n});if(!this.db.objectStoreNames.contains(this.objectStoreName))return t({code:-1,msg:"db not contains objectStoreName"}),r;const n=this.db.transaction([this.objectStoreName],"readwrite").objectStore(this.objectStoreName);return this.handleDBMaxLimit(n).then(r=>{r&&r.countNum<=this.resourceMaxNum&&1024*r.countBlockNum*1024<=this.resourceMaxSize?this.saveNeedSaveData(n).then(()=>{e({code:1,msg:"save data success"})},()=>{t({code:-1,msg:"save data fail"})}):(this.sdk.disableSaveDataByDB=!0,t({code:-1,msg:"db data more than max limit, cancel save"}))},()=>{this.sdk.disableSaveDataByDB=!0,t({code:-1,msg:"before save data handleDBMaxLimit error"})}),r}saveNeedSaveData(e){let t,r;const n=new Promise((e,n)=>{t=e,r=n});let i=0,l=0,u=0;for(let n in this.needSaveResources){let h={id:n,blockIDs:[]},p=this.needSaveResources[n];if(d.default.getInstance().log(`write db -- curNeedSaveResourceID: ${n}, curNeedSaveResourceBlockNum: ${null==p?void 0:p.blockNum}`),!p||!p.blocks||!p.blocks.length)continue;i++;const f=e.get(n);f.onsuccess=m=>{var g,v;let y;if(d.default.getInstance().log(`write db get success -- id: ${n}, blockNum: ${null===(v=null===(g=f.result)||void 0===g?void 0:g.resource)||void 0===v?void 0:v.blockNum}`),f.result&&(y=f.result.resource),y){if(y.blocks||(y.blocks=[]),y.blockNum||(y.blockNum=0),p.priority>=0&&(y.priority=p.priority),p.blocks&&p.blocks.length)for(let e=0;e<p.blocks.length;e++)p.blocks[e]&&!y.blocks[e]&&(y.blocks[e]=p.blocks[e],y.blockNum++,h.blockIDs.push(e));p.totalSize>0&&(y.totalSize=p.totalSize)}let C=null;if(!y){C=p.waitConcatData,delete p.waitConcatData,y=p;for(let e=0;e<y.blocks.length;e++)y.blocks[e]&&h.blockIDs.push(e)}try{if(!this.isReportedPutDB){this.isReportedPutDB=!0;let e={type:c.default.TRACK_TYPE.PUT_DB,version:s.default.getInstance().version,dbVersion:this.dbVersion,dbName:this.dbName,resourceID:n,resourceBlockNum:y.blockNum,resourceTotalSize:y.totalSize,resourcePriority:y.priority};o.default.getInstance().trigger(a.default.TRACK,e)}d.default.getInstance().log(`put data -- id: ${n}, blockNum: ${y.blockNum}`);const p=e.put({id:n,resource:y});p.onsuccess=e=>{var s;d.default.getInstance().log(`put data success -- id: ${n}, blockNum: ${y.blockNum}`),h.blockIDs.length&&(null===(s=this.socketController)||void 0===s||s.report(c.default.RESOURCE_OPTION.ADD,[h])),l++,i===l+u&&(i===l?t({code:1,msg:"save data success"}):r({code:-1,msg:"save data fail"}))},p.onerror=e=>{let h={type:c.default.TRACK_TYPE.PUT_DB_ERROR,version:s.default.getInstance().version,from:1,dbVersion:this.dbVersion,dbName:this.dbName,resourceID:n,resourceBlockNum:y.blockNum,resourceTotalSize:y.totalSize,resourcePriority:y.priority,errorName:"",errorMessage:""};if(e&&e.target&&e.target.error){const t=e.target.error;h.errorName=t.name||"",h.errorMessage=t.message||""}o.default.getInstance().trigger(a.default.TRACK,h),d.default.getInstance().error(`put data error -- id: ${n},  from: onerror, errorMessage: ${h.errorMessage}`),u++,i===l+u&&(i===l?t({code:1,msg:"save data success"}):r({code:-1,msg:"save data fail"}))}}catch(e){let h={type:c.default.TRACK_TYPE.PUT_DB_ERROR,version:s.default.getInstance().version,from:2,dbVersion:this.dbVersion,dbName:this.dbName,resourceID:n,resourceBlockNum:y.blockNum,resourceTotalSize:y.totalSize,resourcePriority:y.priority,errorName:"",errorMessage:e?""+e:""};o.default.getInstance().trigger(a.default.TRACK,h),d.default.getInstance().error(`put data error -- id: ${n}, from: try catch, errorMessage: ${h.errorMessage}`),u++,i===l+u&&(i===l?t({code:1,msg:"save data success"}):r({code:-1,msg:"save data fail"}))}C&&(p.waitConcatData=C),p.blockNum=0,p.blocks=[]},f.onerror=e=>{let s="";e&&e.target&&e.target.error&&(s=e.target.error.message||""),d.default.getInstance().error(`write db get error -- id: ${n}, errorMessage: ${s}`),p.blockNum=0,p.blocks=[],u++,i===l+u&&(i===l?t({code:1,msg:"save data success"}):r({code:-1,msg:"save data fail"}))}}return 0===i&&t({code:1,msg:"save data success"}),n}dbClose(){d.default.getInstance().log("dbClose"),this.db&&(this.db.onclose=null,this.db.close(),this.db=null)}handleDBMaxLimit(e){let t,r;const n=new Promise((e,n)=>{t=e,r=n});let i=0,l=0,u=[];const h=e.openCursor(null,"prev");let p=[];return h.onsuccess=()=>{const n=h.result;if(n){if(n.value&&n.value.resource){let e={id:n.value.resource.id,blocks:[],blockNum:n.value.resource.blockNum,priority:n.value.resource.priority,updateTime:n.value.resource.updateTime};p.push(e)}n.continue()}else{p.sort((function(e,t){return t.updateTime-e.updateTime})),d.default.getInstance().log("tempResourceArr---\x3e",p);let n=p.length;for(let f=this.resourceMaxNum;f<p.length&&!((new Date).getTime()-p[f].updateTime<this.resourceUpdateInterval);f++){i++,d.default.getInstance().log("more than maxNum delete -- id: "+p[f].id);const m=e.delete(p[f].id);m.onsuccess=()=>{var e;d.default.getInstance().log("more than maxNum delete success -- id: "+p[f].id),l++,u.push({id:p[f].id,blockIDs:[]}),l===i&&(null===(e=this.socketController)||void 0===e||e.report(c.default.RESOURCE_OPTION.DEL,u),t({countNum:n,countBlockNum:h,delResources:u}))},m.onerror=e=>{let t={type:c.default.TRACK_TYPE.DEL_DB_ERROR,version:s.default.getInstance().version,from:1,dbVersion:this.dbVersion,dbName:this.dbName,resourceID:p[f].id,errorName:"",errorMessage:""};if(e&&e.target&&e.target.error){const r=e.target.error;t.errorName=r.name||"",t.errorMessage=r.message||""}this.isReportedDelDBErr||(this.isReportedDelDBErr=!0,o.default.getInstance().trigger(a.default.TRACK,t)),d.default.getInstance().error(`more than maxNum delete error -- id: ${p[f].id}, errorMessage: ${t.errorMessage}`),r()},n--}let h=0;for(let f=0;f<p.length&&f<n;f++)if(h+=p[f].blockNum,1024*h*1024>this.resourceMaxSize){if((new Date).getTime()-p[f].updateTime<this.resourceUpdateInterval)break;i++,d.default.getInstance().log("more than maxSize delete -- id: "+p[f].id);const m=e.delete(p[f].id);m.onsuccess=()=>{var e;d.default.getInstance().log("more than maxSize delete success -- id: "+p[f].id),l++,u.push({id:p[f].id,blockIDs:[]}),l===i&&(null===(e=this.socketController)||void 0===e||e.report(c.default.RESOURCE_OPTION.DEL,u),t({countNum:n,countBlockNum:h,delResources:u}))},m.onerror=e=>{let t={type:c.default.TRACK_TYPE.DEL_DB_ERROR,version:s.default.getInstance().version,from:2,dbVersion:this.dbVersion,dbName:this.dbName,resourceID:p[f].id,errorName:"",errorMessage:""};if(e&&e.target&&e.target.error){const r=e.target.error;t.errorName=r.name||"",t.errorMessage=r.message||""}this.isReportedDelDBErr||(this.isReportedDelDBErr=!0,o.default.getInstance().trigger(a.default.TRACK,t)),d.default.getInstance().error(`more than maxSize delete error -- id: ${p[f].id}, errorMessage: ${t.errorMessage}`),r()},h-=p[f].blockNum,n--}d.default.getInstance().log(`handleDBMaxLimit -- countNum: ${n}, countBlockNum: ${h}`),0===i&&t({countNum:n,countBlockNum:h,delResources:u})}},h.onerror=e=>{let t="";e&&e.target&&e.target.error&&(t=e.target.error.message||""),d.default.getInstance().error("handleDBMaxLimit openCursor error -- errorMessage: "+t),r()},n}}n.__decorate([i.default],l.prototype,"onSocketConnect",null),t.default=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(11)),s=n.__importDefault(r(2)),o=n.__importDefault(r(13)),a=r(36),c=n.__importDefault(r(3)),d=n.__importDefault(r(7)),l=r(18),u=r(52);t.default=class{constructor(e){this.getPeerInfoTimeout=2e3,this.sdk=e,this.init()}init(){this.noPeerRecord={},this.events=new o.default;let e="wss://web-player-tracker.biliapi.net";i.default.BROWSER_ENV===l.RUNTIME_MODE.PRE&&(e="wss://pre-web-player-tracker.biliapi.net");try{const t=JSON.parse(i.default.getLocalSettings("bp_nc_config"));(null==t?void 0:t.socketURL)&&"string"==typeof t.socketURL&&(e=t.socketURL)}catch(e){}let t=1e4;i.default.BROWSER_ENV===l.RUNTIME_MODE.DEV&&(t=3e3);let r={buvid:this.sdk.config.buvid?this.sdk.config.buvid:"",sdkVersion:d.default.getInstance().version,aid:""+this.sdk.config.aid,cid:""+this.sdk.config.cid};this.sdk.config.isAdmin&&(r.isAdmin="1"),this.sdk.config.debugKey&&(r.debugKey=this.sdk.config.debugKey),i.default.isChrome()||(r.bkt="1"),this.socket=a.io(e,{autoConnect:!1,reconnectionAttempts:3,reconnectionDelay:t,reconnectionDelayMax:6e4,transports:["websocket"],secure:!0,parser:u,query:r}),this.socket.on("connect",()=>{s.default.getInstance().log(this.socket.id+" connect success"),this.socketID=this.socket.id,this.sdk.saveAndGetDataSwitch=!0,this.trigger(c.default.SOCKET_CONNECT)});const n=()=>{this.socketID="",this.sdk.saveAndGetDataSwitch=!1,this.sdk.saveDataBuvidSwitch=!1,this.sdk.disableGetData=!0};this.socket.on("disconnect",e=>{s.default.getInstance().log("socket disconnect",e),n()}),this.socket.on("connect_error",e=>{s.default.getInstance().log("connection is refused",e.message),n()}),this.socket.on("error",e=>{s.default.getInstance().log("connection error",e.message),n()}),this.socket.on("message",e=>{this.trigger(c.default.SOCKET_MESSAGE,e),e&&e.fromSocketID&&("activePeer"===e.type?this.sdk.saveDataBuvidSwitch=!0:"trackerVersion"===e.type?(this.sdk.trackerVersion=e.version,s.default.getInstance().log("tracker version is: "+this.sdk.trackerVersion)):"enableGetData"===e.type&&(this.sdk.disableGetData=!1,s.default.getInstance().log(`tracker enable getData, aid is ${this.sdk.config.aid}, cid is ${this.sdk.config.cid}`)))}),this.socket.connect()}on(e,t){var r;null===(r=this.events)||void 0===r||r.on(e,t)}off(e,t){var r;null===(r=this.events)||void 0===r||r.off(e,t)}trigger(e,t){var r;null===(r=this.events)||void 0===r||r.trigger(e,t)}getPeerInfo(e,t,r){return new Promise((n,i)=>{var o,a;if(!e||!t||!(null===(o=this.socket)||void 0===o?void 0:o.connected))return i({code:4001,msg:"no valid peer, getPeerInfo sdk internal error"}),void s.default.getInstance().warn(`[getPeerInfo] rid: ${e}, blockIDRange: ${t}, connected: ${null===(a=this.socket)||void 0===a?void 0:a.connected}`);let c=window.setTimeout(()=>{c=0,i({code:4004,msg:"no valid peer, getPeerInfo timeout"}),this.handleNoPeerRecord(e)},this.getPeerInfoTimeout);this.socket.emit("getPeerInfoV3",e,t,"",r,t=>{if(c)s.default.getInstance().log(`[getPeerInfo] rid: ${e} res:`,t),window.clearTimeout(c),c=0,2e3===t.code||1===t.code?n(t):i(t),this.handleNoPeerRecord(e,null==t?void 0:t.peers);else{const r=null==t?void 0:t.peers;if(null==r?void 0:r.length)for(let t=0;t<r.length;t++){const n=r[t];(null==n?void 0:n.id)&&this.releasePeerInfo(n.id,e)}}})})}handleNoPeerRecord(e,t){if(!e)return;let r=this.noPeerRecord[e];if(null==t?void 0:t.length)r&&(r.noPeerCount=0,r.disableNCTimer&&(window.clearTimeout(r.disableNCTimer),r.disableNCTimer=0),delete this.noPeerRecord[e]);else{r||(this.noPeerRecord[e]=r={rid:e,noPeerCount:0,disableNCTimer:0}),r.noPeerCount++;const t=3;if(!r.disableNCTimer&&r.noPeerCount%t==0){const e=60*Math.floor(r.noPeerCount/t)*1e3+30*Math.random()*1e3;r.disableNCTimer=window.setTimeout(()=>{r.disableNCTimer=0},e)}}}releasePeerInfo(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.socket.emit("releasePeerInfo",e,t)}sendMessage(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.socket.emit("message",e,t)}report(e,t){var r;e&&(null==t?void 0:t.length)&&(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.socket.emit("report",e,t)}reportRTCState(e,t,r,n){var i;(null===(i=this.socket)||void 0===i?void 0:i.connected)&&this.socket.emit("reportRTCState",e,t,r,n)}getNodeVar(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.socket.emit("getVar",e,t)}hotPushToTracker(e,t){var r;(null===(r=this.socket)||void 0===r?void 0:r.connected)&&this.socket.emit("hotPushToTracker",e,t)}destroy(){this.socket&&(this.socket.off("connect"),this.socket.off("disconnect"),this.socket.off("message"),this.socketID="",this.socket.disconnect(),this.socket=null),this.events&&(this.events.destroy(),this.events=null);for(let e in this.noPeerRecord){const t=this.noPeerRecord[e];(null==t?void 0:t.disableNCTimer)&&(window.clearTimeout(t.disableNCTimer),t.disableNCTimer=0)}this.noPeerRecord={}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=t.io=t.Manager=t.protocol=void 0;const n=r(37),i=r(20),s=r(27);Object.defineProperty(t,"Socket",{enumerable:!0,get:function(){return s.Socket}});const o=r(1)("socket.io-client");e.exports=t=c;const a=t.managers={};function c(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};const r=n.url(e,t.path),s=r.source,c=r.id,d=r.path,l=a[c]&&d in a[c].nsps;let u;return t.forceNew||t["force new connection"]||!1===t.multiplex||l?(o("ignoring socket cache for %s",s),u=new i.Manager(s,t)):(a[c]||(o("new io instance for %s",s),a[c]=new i.Manager(s,t)),u=a[c]),r.query&&!t.query&&(t.query=r.queryKey),u.socket(r.path,t)}t.io=c;var d=r(16);Object.defineProperty(t,"protocol",{enumerable:!0,get:function(){return d.protocol}}),t.connect=c;var l=r(20);Object.defineProperty(t,"Manager",{enumerable:!0,get:function(){return l.Manager}})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.url=void 0;const n=r(19),i=r(1)("socket.io-client:url");t.url=function(e,t="",r){let s=e;r=r||"undefined"!=typeof location&&location,null==e&&(e=r.protocol+"//"+r.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?r.protocol+e:r.host+e),/^(https?|wss?):\/\//.test(e)||(i("protocol-less url %s",e),e=void 0!==r?r.protocol+"//"+e:"https://"+e),i("parse %s",e),s=n(e)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const o=-1!==s.host.indexOf(":")?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+o+":"+s.port+t,s.href=s.protocol+"://"+o+(r&&r.port===s.port?"":":"+s.port),s}},function(e,t,r){e.exports=function(e){function t(e){let r,i,s,o=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),s=i-(r||i);n.diff=s,n.prev=r,n.curr=i,r=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(r,i)=>{if("%%"===r)return"%";o++;const s=t.formatters[i];if("function"==typeof s){const t=e[o];r=s.call(n,t),e.splice(o,1),o--}return r}),t.formatArgs.call(n,e),(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==t.namespaces&&(i=t.namespaces,s=t.enabled(e)),s),set:e=>{o=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function i(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names.map(i),...t.skips.map(i).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),i=n.length;for(r=0;r<i;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=r(39),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(r=>{t[r]=e[r]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t}},function(e,t){var r=1e3,n=6e4,i=60*n,s=24*i;function o(e,t,r,n){var i=t>=1.5*r;return Math.round(e/r)+" "+n+(i?"s":"")}e.exports=function(e,t){t=t||{};var a,c,d=typeof e;if("string"===d&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var o=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return 6048e5*o;case"days":case"day":case"d":return o*s;case"hours":case"hour":case"hrs":case"hr":case"h":return o*i;case"minutes":case"minute":case"mins":case"min":case"m":return o*n;case"seconds":case"second":case"secs":case"sec":case"s":return o*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(e);if("number"===d&&isFinite(e))return t.long?(a=e,(c=Math.abs(a))>=s?o(a,c,s,"day"):c>=i?o(a,c,i,"hour"):c>=n?o(a,c,n,"minute"):c>=r?o(a,c,r,"second"):a+" ms"):function(e){var t=Math.abs(e);return t>=s?Math.round(e/s)+"d":t>=i?Math.round(e/i)+"h":t>=n?Math.round(e/n)+"m":t>=r?Math.round(e/r)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,r){const n=r(41);e.exports=(e,t)=>new n(e,t),e.exports.Socket=n,e.exports.protocol=n.protocol,e.exports.Transport=r(14),e.exports.transports=r(21),e.exports.parser=r(8)},function(e,t,r){const n=r(21),i=r(4),s=r(1)("engine.io-client:socket"),o=r(8),a=r(19),c=r(15);class d extends i{constructor(e,t={}){super(),e&&"object"==typeof e&&(t=e,e=null),e?(e=a(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=a(t.host).host),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,jsonp:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{}},t),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"==typeof this.opts.query&&(this.opts.query=c.decode(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"==typeof addEventListener&&addEventListener("beforeunload",()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},!1),this.open()}createTransport(e){s('creating transport "%s"',e);const t=function(e){const t={};for(let r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}(this.opts.query);t.EIO=o.protocol,t.transport=e,this.id&&(t.sid=this.id);const r=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return s("options: %j",r),new n[e](r)}open(){let e;if(this.opts.rememberUpgrade&&d.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){const e=this;return void setTimeout((function(){e.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return s("error while creating transport: %s",e),this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){s("setting transport %s",e.name);const t=this;this.transport&&(s("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))}probe(e){s('probing transport "%s"',e);let t=this.createTransport(e,{probe:1}),r=!1;const n=this;function i(){if(n.onlyBinaryUpgrades){const e=!this.supportsBinary&&n.transport.supportsBinary;r=r||e}r||(s('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(i){if(!r)if("pong"===i.type&&"probe"===i.data){if(s('probe transport "%s" pong',e),n.upgrading=!0,n.emit("upgrading",t),!t)return;d.priorWebsocketSuccess="websocket"===t.name,s('pausing current transport "%s"',n.transport.name),n.transport.pause((function(){r||"closed"!==n.readyState&&(s("changing transport and sending upgrade packet"),h(),n.setTransport(t),t.send([{type:"upgrade"}]),n.emit("upgrade",t),t=null,n.upgrading=!1,n.flush())}))}else{s('probe transport "%s" failed',e);const r=new Error("probe error");r.transport=t.name,n.emit("upgradeError",r)}})))}function o(){r||(r=!0,h(),t.close(),t=null)}function a(r){const i=new Error("probe error: "+r);i.transport=t.name,o(),s('probe transport "%s" failed because of error: %s',e,r),n.emit("upgradeError",i)}function c(){a("transport closed")}function l(){a("socket closed")}function u(e){t&&e.name!==t.name&&(s('"%s" works - aborting "%s"',e.name,t.name),o())}function h(){t.removeListener("open",i),t.removeListener("error",a),t.removeListener("close",c),n.removeListener("close",l),n.removeListener("upgrading",u)}d.priorWebsocketSuccess=!1,t.once("open",i),t.once("error",a),t.once("close",c),this.once("close",l),this.once("upgrading",u),t.open()}onOpen(){if(s("socket open"),this.readyState="open",d.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause){s("starting upgrade probes");let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(s('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emit("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else s('packet received with socket readyState "%s"',this.readyState)}onHandshake(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){clearTimeout(this.pingTimeoutTimer),this.pingTimeoutTimer=setTimeout(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout)}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()}flush(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(s("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))}write(e,t,r){return this.sendPacket("message",e,t,r),this}send(e,t,r){return this.sendPacket("message",e,t,r),this}sendPacket(e,t,r,n){if("function"==typeof t&&(n=t,t=void 0),"function"==typeof r&&(n=r,r=null),"closing"===this.readyState||"closed"===this.readyState)return;(r=r||{}).compress=!1!==r.compress;const i={type:e,data:t,options:r};this.emit("packetCreate",i),this.writeBuffer.push(i),n&&this.once("flush",n),this.flush()}close(){const e=this;function t(){e.onClose("forced close"),s("socket closing - telling transport to close"),e.transport.close()}function r(){e.removeListener("upgrade",r),e.removeListener("upgradeError",r),t()}function n(){e.once("upgrade",r),e.once("upgradeError",r)}return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(function(){this.upgrading?n():t()})):this.upgrading?n():t()),this}onError(e){s("socket error %j",e),d.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)}onClose(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){s('socket close with reason: "%s"',e);const r=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),r.writeBuffer=[],r.prevBufferLen=0}}filterUpgrades(e){const t=[];let r=0;const n=e.length;for(;r<n;r++)~this.transports.indexOf(e[r])&&t.push(e[r]);return t}}d.priorWebsocketSuccess=!1,d.protocol=o.protocol,e.exports=d},function(e,t){try{e.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){e.exports=!1}},function(e,t,r){const n=r(22),i=r(23),s=r(4),{pick:o}=r(26),a=r(9),c=r(1)("engine.io-client:polling-xhr");function d(){}const l=null!=new n({xdomain:!1}).responseType;class u extends s{constructor(e,t){super(),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.create()}create(){const e=o(this.opts,"agent","enablesXDR","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new n(e),r=this;try{c("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let e in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(e)&&t.setRequestHeader(e,this.opts.extraHeaders[e])}}catch(e){}if("POST"===this.method)try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),this.hasXDR()?(t.onload=function(){r.onLoad()},t.onerror=function(){r.onError(t.responseText)}):t.onreadystatechange=function(){4===t.readyState&&(200===t.status||1223===t.status?r.onLoad():setTimeout((function(){r.onError("number"==typeof t.status?t.status:0)}),0))},c("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){r.onError(e)}),0)}"undefined"!=typeof document&&(this.index=u.requestsCount++,u.requests[this.index]=this)}onSuccess(){this.emit("success"),this.cleanup()}onData(e){this.emit("data",e),this.onSuccess()}onError(e){this.emit("error",e),this.cleanup(!0)}cleanup(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=d:this.xhr.onreadystatechange=d,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete u.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;null!==e&&this.onData(e)}hasXDR(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR}abort(){this.cleanup()}}function h(){for(let e in u.requests)u.requests.hasOwnProperty(e)&&u.requests[e].abort()}u.requestsCount=0,u.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",h):"function"==typeof addEventListener&&addEventListener("onpagehide"in a?"pagehide":"unload",h,!1)),e.exports=class extends i{constructor(e){if(super(e),"undefined"!=typeof location){const t="https:"===location.protocol;let r=location.port;r||(r=t?443:80),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||r!==e.port,this.xs=e.secure!==t}const t=e&&e.forceBase64;this.supportsBinary=l&&!t}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new u(this.uri(),e)}doWrite(e,t){const r=this.request({method:"POST",data:e}),n=this;r.on("success",t),r.on("error",(function(e){n.onError("xhr post error",e)}))}doPoll(){c("xhr poll");const e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e}},e.exports.Request=u},function(e,t,r){const{PACKET_TYPES:n}=r(24),i="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),s="function"==typeof ArrayBuffer,o=(e,t)=>{const r=new FileReader;return r.onload=function(){const e=r.result.split(",")[1];t("b"+e)},r.readAsDataURL(e)};e.exports=({type:e,data:t},r,a)=>{return i&&t instanceof Blob?r?a(t):o(t,a):s&&(t instanceof ArrayBuffer||(c=t,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(c):c&&c.buffer instanceof ArrayBuffer))?r?a(t):o(new Blob([t]),a):a(n[e]+(t||""));var c}},function(e,t,r){const{PACKET_TYPES_REVERSE:n,ERROR_PACKET:i}=r(24);let s;"function"==typeof ArrayBuffer&&(s=r(46));const o=(e,t)=>{if(s){const r=s.decode(e);return a(r,t)}return{base64:!0,data:e}},a=(e,t)=>{switch(t){case"blob":return e instanceof ArrayBuffer?new Blob([e]):e;case"arraybuffer":default:return e}};e.exports=(e,t)=>{if("string"!=typeof e)return{type:"message",data:a(e,t)};const r=e.charAt(0);return"b"===r?{type:"message",data:o(e.substring(1),t)}:n[r]?e.length>1?{type:n[r],data:e.substring(1)}:{type:n[r]}:i}},function(e,t){!function(e){"use strict";t.encode=function(t){var r,n=new Uint8Array(t),i=n.length,s="";for(r=0;r<i;r+=3)s+=e[n[r]>>2],s+=e[(3&n[r])<<4|n[r+1]>>4],s+=e[(15&n[r+1])<<2|n[r+2]>>6],s+=e[63&n[r+2]];return i%3==2?s=s.substring(0,s.length-1)+"=":i%3==1&&(s=s.substring(0,s.length-2)+"=="),s},t.decode=function(t){var r,n,i,s,o,a=.75*t.length,c=t.length,d=0;"="===t[t.length-1]&&(a--,"="===t[t.length-2]&&a--);var l=new ArrayBuffer(a),u=new Uint8Array(l);for(r=0;r<c;r+=4)n=e.indexOf(t[r]),i=e.indexOf(t[r+1]),s=e.indexOf(t[r+2]),o=e.indexOf(t[r+3]),u[d++]=n<<2|i>>4,u[d++]=(15&i)<<4|s>>2,u[d++]=(3&s)<<6|63&o;return l}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},function(e,t,r){const n=r(23),i=r(9),s=/\n/g,o=/\\n/g;let a;e.exports=class extends n{constructor(e){super(e),this.query=this.query||{},a||(a=i.___eio=i.___eio||[]),this.index=a.length;const t=this;a.push((function(e){t.onData(e)})),this.query.j=this.index}get supportsBinary(){return!1}doClose(){this.script&&(this.script.onerror=()=>{},this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),super.doClose()}doPoll(){const e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};const r=document.getElementsByTagName("script")[0];r?r.parentNode.insertBefore(t,r):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){const e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)}doWrite(e,t){const r=this;let n;if(!this.form){const e=document.createElement("form"),t=document.createElement("textarea"),r=this.iframeId="eio_iframe_"+this.index;e.className="socketio",e.style.position="absolute",e.style.top="-1000px",e.style.left="-1000px",e.target=r,e.method="POST",e.setAttribute("accept-charset","utf-8"),t.name="d",e.appendChild(t),document.body.appendChild(e),this.form=e,this.area=t}function i(){a(),t()}function a(){if(r.iframe)try{r.form.removeChild(r.iframe)}catch(e){r.onError("jsonp polling iframe removal error",e)}try{const e='<iframe src="javascript:0" name="'+r.iframeId+'">';n=document.createElement(e)}catch(e){n=document.createElement("iframe"),n.name=r.iframeId,n.src="javascript:0"}n.id=r.iframeId,r.form.appendChild(n),r.iframe=n}this.form.action=this.uri(),a(),e=e.replace(o,"\\\n"),this.area.value=e.replace(s,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===r.iframe.readyState&&i()}:this.iframe.onload=i}}},function(e,t,r){const n=r(14),i=r(8),s=r(15),o=r(25),{pick:a}=r(26),{WebSocket:c,usingBrowserWebSocket:d,defaultBinaryType:l}=r(49),u=r(1)("engine.io-client:websocket"),h="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class p extends n{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,r=h?{}:a(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(r.headers=this.opts.extraHeaders);try{this.ws=d&&!h?t?new c(e,t):new c(e):new c(e,t,r)}catch(e){return this.emit("error",e)}this.ws.binaryType=this.socket.binaryType||l,this.addEventListeners()}addEventListeners(){const e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}}write(e){const t=this;this.writable=!1;let r=e.length,n=0;const s=r;for(;n<s;n++)!function(e){i.encodePacket(e,t.supportsBinary,(function(n){const i={};!d&&(e.options&&(i.compress=e.options.compress),t.opts.perMessageDeflate)&&("string"==typeof n?Buffer.byteLength(n):n.length)<t.opts.perMessageDeflate.threshold&&(i.compress=!1);try{d?t.ws.send(n):t.ws.send(n,i)}catch(e){u("websocket closed before onclose event")}--r||(t.emit("flush"),setTimeout((function(){t.writable=!0,t.emit("drain")}),0))}))}(e[n])}onClose(){n.prototype.onClose.call(this)}doClose(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let r="";return this.opts.port&&("wss"===t&&443!==Number(this.opts.port)||"ws"===t&&80!==Number(this.opts.port))&&(r=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=o()),this.supportsBinary||(e.b64=1),e=s.encode(e),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+r+this.opts.path+e}check(){return!(!c||"__initialize"in c&&this.name===p.prototype.name)}}e.exports=p},function(e,t,r){const n=r(9);e.exports={WebSocket:n.WebSocket||n.MozWebSocket,usingBrowserWebSocket:!0,defaultBinaryType:"arraybuffer"}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reconstructPacket=t.deconstructPacket=void 0;const n=r(28);t.deconstructPacket=function(e){const t=[],r=e.data,i=e;return i.data=function e(t,r){if(!t)return t;if(n.isBinary(t)){const e={_placeholder:!0,num:r.length};return r.push(t),e}if(Array.isArray(t)){const n=new Array(t.length);for(let i=0;i<t.length;i++)n[i]=e(t[i],r);return n}if("object"==typeof t&&!(t instanceof Date)){const n={};for(const i in t)t.hasOwnProperty(i)&&(n[i]=e(t[i],r));return n}return t}(r,t),i.attachments=t.length,{packet:i,buffers:t}},t.reconstructPacket=function(e,t){return e.data=function e(t,r){if(!t)return t;if(t&&t._placeholder)return r[t.num];if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=e(t[n],r);else if("object"==typeof t)for(const n in t)t.hasOwnProperty(n)&&(t[n]=e(t[n],r));return t}(e.data,t),e.attachments=void 0,e}},function(e,t){function r(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}e.exports=r,r.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-r:e+r}return 0|Math.min(e,this.max)},r.prototype.reset=function(){this.attempts=0},r.prototype.setMin=function(e){this.ms=e},r.prototype.setMax=function(e){this.max=e},r.prototype.setJitter=function(e){this.jitter=e}},function(e,t,r){var n=r(53),i=r(4);t.protocol=5;var s=t.PacketType={CONNECT:0,DISCONNECT:1,EVENT:2,ACK:3,CONNECT_ERROR:4},o=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},a=function(e){return"string"==typeof e},c=function(e){return"[object Object]"===Object.prototype.toString.call(e)};function d(){}function l(){}d.prototype.encode=function(e){return[n.encode(e)]},i(l.prototype),l.prototype.add=function(e){var t=n.decode(e);this.checkPacket(t),this.emit("decoded",t)},l.prototype.checkPacket=function(e){if(!(o(e.type)&&e.type>=s.CONNECT&&e.type<=s.CONNECT_ERROR))throw new Error("invalid packet type");if(!a(e.nsp))throw new Error("invalid namespace");if(!function(e){switch(e.type){case s.CONNECT:return void 0===e.data||c(e.data);case s.DISCONNECT:return void 0===e.data;case s.CONNECT_ERROR:return a(e.data)||c(e.data);default:return Array.isArray(e.data)}}(e))throw new Error("invalid payload");if(void 0!==e.id&&!o(e.id))throw new Error("invalid packet id")},l.prototype.destroy=function(){},t.Encoder=d,t.Decoder=l},function(e,t,r){t.encode=r(54),t.decode=r(55)},function(e,t,r){"use strict";function n(e,t,r){for(var n=0,i=0,s=r.length;i<s;i++)(n=r.charCodeAt(i))<128?e.setUint8(t++,n):n<2048?(e.setUint8(t++,192|n>>6),e.setUint8(t++,128|63&n)):n<55296||n>=57344?(e.setUint8(t++,224|n>>12),e.setUint8(t++,128|n>>6&63),e.setUint8(t++,128|63&n)):(i++,n=65536+((1023&n)<<10|1023&r.charCodeAt(i)),e.setUint8(t++,240|n>>18),e.setUint8(t++,128|n>>12&63),e.setUint8(t++,128|n>>6&63),e.setUint8(t++,128|63&n))}e.exports=function(e){var t=[],r=[],i=function e(t,r,n){var i=typeof n,s=0,o=0,a=0,c=0,d=0,l=0;if("string"===i){if((d=function(e){for(var t=0,r=0,n=0,i=e.length;n<i;n++)(t=e.charCodeAt(n))<128?r+=1:t<2048?r+=2:t<55296||t>=57344?r+=3:(n++,r+=4);return r}(n))<32)t.push(160|d),l=1;else if(d<256)t.push(217,d),l=2;else if(d<65536)t.push(218,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("String too long");t.push(219,d>>24,d>>16,d>>8,d),l=5}return r.push({_str:n,_length:d,_offset:t.length}),l+d}if("number"===i)return Math.floor(n)===n&&isFinite(n)?n>=0?n<128?(t.push(n),1):n<256?(t.push(204,n),2):n<65536?(t.push(205,n>>8,n),3):n<4294967296?(t.push(206,n>>24,n>>16,n>>8,n),5):(a=n/Math.pow(2,32)>>0,c=n>>>0,t.push(207,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):n>=-32?(t.push(n),1):n>=-128?(t.push(208,n),2):n>=-32768?(t.push(209,n>>8,n),3):n>=-2147483648?(t.push(210,n>>24,n>>16,n>>8,n),5):(a=Math.floor(n/Math.pow(2,32)),c=n>>>0,t.push(211,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):(t.push(203),r.push({_float:n,_length:8,_offset:t.length}),9);if("object"===i){if(null===n)return t.push(192),1;if(Array.isArray(n)){if((d=n.length)<16)t.push(144|d),l=1;else if(d<65536)t.push(220,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("Array too large");t.push(221,d>>24,d>>16,d>>8,d),l=5}for(s=0;s<d;s++)l+=e(t,r,n[s]);return l}if(n instanceof Date){var u=n.getTime();return a=Math.floor(u/Math.pow(2,32)),c=u>>>0,t.push(215,0,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),10}if(n instanceof ArrayBuffer){if((d=n.byteLength)<256)t.push(196,d),l=2;else if(d<65536)t.push(197,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("Buffer too large");t.push(198,d>>24,d>>16,d>>8,d),l=5}return r.push({_bin:n,_length:d,_offset:t.length}),l+d}if("function"==typeof n.toJSON)return e(t,r,n.toJSON());var h=[],p="",f=Object.keys(n);for(s=0,o=f.length;s<o;s++)"function"!=typeof n[p=f[s]]&&h.push(p);if((d=h.length)<16)t.push(128|d),l=1;else if(d<65536)t.push(222,d>>8,d),l=3;else{if(!(d<4294967296))throw new Error("Object too large");t.push(223,d>>24,d>>16,d>>8,d),l=5}for(s=0;s<d;s++)l+=e(t,r,p=h[s]),l+=e(t,r,n[p]);return l}if("boolean"===i)return t.push(n?195:194),1;if("undefined"===i)return t.push(212,0,0),3;throw new Error("Could not encode")}(t,r,e),s=new ArrayBuffer(i),o=new DataView(s),a=0,c=0,d=-1;r.length>0&&(d=r[0]._offset);for(var l,u=0,h=0,p=0,f=t.length;p<f;p++)if(o.setUint8(c+p,t[p]),p+1===d){if(u=(l=r[a])._length,h=c+d,l._bin)for(var m=new Uint8Array(l._bin),g=0;g<u;g++)o.setUint8(h+g,m[g]);else l._str?n(o,h,l._str):void 0!==l._float&&o.setFloat64(h,l._float);c+=u,r[++a]&&(d=r[a]._offset)}return s}},function(e,t,r){"use strict";function n(e){if(this._offset=0,e instanceof ArrayBuffer)this._buffer=e,this._view=new DataView(this._buffer);else{if(!ArrayBuffer.isView(e))throw new Error("Invalid argument");this._buffer=e.buffer,this._view=new DataView(this._buffer,e.byteOffset,e.byteLength)}}n.prototype._array=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=this._parse();return t},n.prototype._map=function(e){for(var t={},r=0;r<e;r++)t[this._parse()]=this._parse();return t},n.prototype._str=function(e){var t=function(e,t,r){for(var n="",i=0,s=t,o=t+r;s<o;s++){var a=e.getUint8(s);if(0!=(128&a))if(192!=(224&a))if(224!=(240&a)){if(240!=(248&a))throw new Error("Invalid byte "+a.toString(16));(i=(7&a)<<18|(63&e.getUint8(++s))<<12|(63&e.getUint8(++s))<<6|(63&e.getUint8(++s))<<0)>=65536?(i-=65536,n+=String.fromCharCode(55296+(i>>>10),56320+(1023&i))):n+=String.fromCharCode(i)}else n+=String.fromCharCode((15&a)<<12|(63&e.getUint8(++s))<<6|(63&e.getUint8(++s))<<0);else n+=String.fromCharCode((31&a)<<6|63&e.getUint8(++s));else n+=String.fromCharCode(a)}return n}(this._view,this._offset,e);return this._offset+=e,t},n.prototype._bin=function(e){var t=this._buffer.slice(this._offset,this._offset+e);return this._offset+=e,t},n.prototype._parse=function(){var e,t=this._view.getUint8(this._offset++),r=0,n=0,i=0,s=0;if(t<192)return t<128?t:t<144?this._map(15&t):t<160?this._array(15&t):this._str(31&t);if(t>223)return-1*(255-t+1);switch(t){case 192:return null;case 194:return!1;case 195:return!0;case 196:return r=this._view.getUint8(this._offset),this._offset+=1,this._bin(r);case 197:return r=this._view.getUint16(this._offset),this._offset+=2,this._bin(r);case 198:return r=this._view.getUint32(this._offset),this._offset+=4,this._bin(r);case 199:return r=this._view.getUint8(this._offset),n=this._view.getInt8(this._offset+1),this._offset+=2,[n,this._bin(r)];case 200:return r=this._view.getUint16(this._offset),n=this._view.getInt8(this._offset+2),this._offset+=3,[n,this._bin(r)];case 201:return r=this._view.getUint32(this._offset),n=this._view.getInt8(this._offset+4),this._offset+=5,[n,this._bin(r)];case 202:return e=this._view.getFloat32(this._offset),this._offset+=4,e;case 203:return e=this._view.getFloat64(this._offset),this._offset+=8,e;case 204:return e=this._view.getUint8(this._offset),this._offset+=1,e;case 205:return e=this._view.getUint16(this._offset),this._offset+=2,e;case 206:return e=this._view.getUint32(this._offset),this._offset+=4,e;case 207:return i=this._view.getUint32(this._offset)*Math.pow(2,32),s=this._view.getUint32(this._offset+4),this._offset+=8,i+s;case 208:return e=this._view.getInt8(this._offset),this._offset+=1,e;case 209:return e=this._view.getInt16(this._offset),this._offset+=2,e;case 210:return e=this._view.getInt32(this._offset),this._offset+=4,e;case 211:return i=this._view.getInt32(this._offset)*Math.pow(2,32),s=this._view.getUint32(this._offset+4),this._offset+=8,i+s;case 212:return n=this._view.getInt8(this._offset),this._offset+=1,0===n?void(this._offset+=1):[n,this._bin(1)];case 213:return n=this._view.getInt8(this._offset),this._offset+=1,[n,this._bin(2)];case 214:return n=this._view.getInt8(this._offset),this._offset+=1,[n,this._bin(4)];case 215:return n=this._view.getInt8(this._offset),this._offset+=1,0===n?(i=this._view.getInt32(this._offset)*Math.pow(2,32),s=this._view.getUint32(this._offset+4),this._offset+=8,new Date(i+s)):[n,this._bin(8)];case 216:return n=this._view.getInt8(this._offset),this._offset+=1,[n,this._bin(16)];case 217:return r=this._view.getUint8(this._offset),this._offset+=1,this._str(r);case 218:return r=this._view.getUint16(this._offset),this._offset+=2,this._str(r);case 219:return r=this._view.getUint32(this._offset),this._offset+=4,this._str(r);case 220:return r=this._view.getUint16(this._offset),this._offset+=2,this._array(r);case 221:return r=this._view.getUint32(this._offset),this._offset+=4,this._array(r);case 222:return r=this._view.getUint16(this._offset),this._offset+=2,this._map(r);case 223:return r=this._view.getUint32(this._offset),this._offset+=4,this._map(r)}throw new Error("Could not parse")},e.exports=function(e){var t=new n(e),r=t._parse();if(t._offset!==e.byteLength)throw new Error(e.byteLength-t._offset+" trailing bytes");return r}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(0),i=n.__importDefault(r(3)),s=n.__importDefault(r(10)),o=n.__importDefault(r(2)),a=r(57);class c{constructor(e,t){this.peerRtcInfoByRid={},this.receivedBufferInfoByRid={},this.retryCountMax=2,this.sdk=e,this.socketController=t}createWorkShop(e,t,r,s,o,c){var d,l;return n.__awaiter(this,void 0,void 0,(function*(){if(this.peerRtcInfoByRid[e]||(this.peerRtcInfoByRid[e]={}),this.peerRtcInfoByRid[e].rid=e,this.peerRtcInfoByRid[e].originRange=t,this.peerRtcInfoByRid[e].originToken=r,this.peerRtcInfoByRid[e].bitrate=s,this.peerRtcInfoByRid[e].latency=o,this.peerRtcInfoByRid[e].retryCount=c,this.peerRtcInfoByRid[e].startTime=Date.now(),null===(l=null===(d=this.peerRtcInfoByRid[e])||void 0===d?void 0:d.peerRtcControllers)||void 0===l?void 0:l.length)return;const{peers:n,shouldResPeerNum:u}=yield this.getPeers(e);this.peerRtcInfoByRid[e].peerRtcControllers=[],this.peerRtcInfoByRid[e].totalPeerCount=u;for(let t=0;t<n.length;t++){const r=new a.WebRTCLeecher(this.sdk,this.socketController,n[t].id,Boolean(n[t].isSameIP),e,t+1);r.createOffer(),r.on(i.default.WEBRTC_CHANNEL_OPEN,()=>{}),r.on(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),r.on(i.default.WEBRTC_CONNECT_TIMEOUT,this.onWebRTCConnectTimeout),r.on(i.default.WEBRTC_GET_DATA_TIMEOUT,this.onWebRTCGetDataTimeout),this.peerRtcInfoByRid[e].peerRtcControllers.push(r)}}))}setUseRanges(e){return n.__awaiter(this,void 0,void 0,(function*(){const t=this.peerRtcInfoByRid[e].originRange,r=this.peerRtcInfoByRid[e].peerRtcControllers.length;if(r<=1)return void(this.peerRtcInfoByRid[e].useRanges=[t]);const n=t.start,i=t.end,s=Math.floor((i-n+1)/r),o=Math.floor((i-n+1)%r);if(s<=1)return void(this.peerRtcInfoByRid[e].useRanges=[t]);const a=[];for(let e=0;e<r;e++){let t=n+e*s,i=n+(e+1)*s-1;e===r-1&&(i+=o),a.push({start:t,end:i})}this.peerRtcInfoByRid[e].useRanges=a}))}getPeers(e){return n.__awaiter(this,void 0,void 0,(function*(){const{originRange:t,bitrate:r}=this.peerRtcInfoByRid[e];return yield this.socketController.getPeerInfo(e,t,r)}))}createFlowLine(e,t){return n.__awaiter(this,void 0,void 0,(function*(){let{useRanges:t,originToken:r,originRange:n,bitrate:i,latency:s,retryCount:o,startTime:a}=this.peerRtcInfoByRid[e];const c=[];this.peerRtcInfoByRid[e].peerRtcControllers.length<1&&(yield this.createWorkShop(e,n,r,i,s,o),yield this.setUseRanges(e),t=this.peerRtcInfoByRid[e].useRanges);for(let i=0;i<t.length;i++){const d=this.peerRtcInfoByRid[e].peerRtcControllers[i];d&&c.push(d.getData({rid:e,originRange:n,useRange:t[i],originToken:r,token:r+"-"+t[i].end,startTime:a||Date.now(),latency:s,retryCount:o}))}this.peerRtcInfoByRid[e].bufferPromise=c}))}mergeFlowLines(e,t=0){return new Promise((r,i)=>{const{bufferPromise:s}=this.peerRtcInfoByRid[e],o=[],a=[];if(s&&s.length)for(let c=0;c<s.length;c++)s[c].then(e=>{o.push(e)}).catch(e=>{a.push(e)}).finally(()=>n.__awaiter(this,void 0,void 0,(function*(){if(delete this.peerRtcInfoByRid[e].bufferPromise,a.length>0)return i(a[0]),void this.clearReceivedBufferInfo(e);yield this.handlePromiseFulfilledResult(e,o),yield this.handlePromiseRejectedResult(e,a,t),o.length===s.length&&r()})))})}handlePromiseFulfilledResult(e,t){return n.__awaiter(this,void 0,void 0,(function*(){if(t.length)for(let r=0;r<t.length;r++){const{start:n,end:i}=t[r].responseData.useRange,s=`${n}-${i}`;this.receivedBufferInfoByRid[e]||(this.receivedBufferInfoByRid[e]={}),this.receivedBufferInfoByRid[e][s]=t[r]}}))}handlePromiseRejectedResult(e,t,r){return n.__awaiter(this,void 0,void 0,(function*(){if(!t.length)return;if(r>this.retryCountMax)return;const n=[];for(let e=0;e<t.length;e++)n.push(t[e].responseData.useRange);yield this.createFlowLine(e,n),yield this.mergeFlowLines(e,++r)}))}mergeRanges(e,t,r){const n=t.sort((e,t)=>e.start-t.start),i=n[0].start,s=n[n.length-1].end;for(let t=0;t<n.length;t++){const{start:r,end:i}=n[t],s=this.peerRtcInfoByRid[e].useRanges.findIndex(e=>e.start===r&&e.end===i);this.peerRtcInfoByRid[e].useRanges.splice(s,1)}const o={start:i,end:s};return this.peerRtcInfoByRid[e].useRanges.push(o),[o]}mergeResult(e){const t=Object.keys(this.receivedBufferInfoByRid[e]).sort((e,t)=>+e.split("-")[0]-+t.split("-")[0]);let r,n,i,s=[];for(let r=0;r<t.length;r++){s.push(this.receivedBufferInfoByRid[e][t[r]].responseData.cPeerSID);const{uint8:o,originRange:a}=this.receivedBufferInfoByRid[e][t[r]].responseData,c=a.end-a.start+1;n||(n=new Uint8Array(c),i=0),n.set(o,i),i+=o.byteLength}return r={code:this.receivedBufferInfoByRid[e][t[0]].code,msg:this.receivedBufferInfoByRid[e][t[0]].msg,responseData:Object.assign(Object.assign({},this.receivedBufferInfoByRid[e][t[0]].responseData),{usePeerSids:s})},r.responseData.retryCount=this.peerRtcInfoByRid[e].retryCount,r.responseData.data=n.buffer,r.responseData.gotDataByte=n.byteLength,r.responseData.getDataTime=Date.now()-r.responseData.startTime,delete r.responseData.uint8,delete r.responseData.useRange,delete r.responseData.cPeerSID,this.clearReceivedBufferInfo(e),r}clearReceivedBufferInfo(e){delete this.receivedBufferInfoByRid[e]}clearPeerInfo(e){delete this.peerRtcInfoByRid[e]}onWebRTCGetDataTimeout(e,t,r,n){o.default.getInstance().log(`[onWebRTCGetDataTimeout], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}onWebRTCConnectTimeout(e,t,r){o.default.getInstance().log(`[onWebRTCConnectTimeout], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}onWebRTCChannelClose(e,t,r){o.default.getInstance().log(`[onWebRTCChannelClose], sid: ${e}, rid: ${t}, index: ${r}`),this.releasePeer(t,r)}releasePeer(e,t){var r;o.default.getInstance().log(`[releasePeer], rid: ${e}, arg: ${t}`);for(let n=0;n<(null===(r=this.peerRtcInfoByRid[e].peerRtcControllers)||void 0===r?void 0:r.length);n++){const r=this.peerRtcInfoByRid[e].peerRtcControllers[n];r.path!==e||r.index!==t&&!0!==t||(this.socketController.releasePeerInfo(r.cPeerSocketID,e),r.off(i.default.WEBRTC_CHANNEL_OPEN),r.off(i.default.WEBRTC_CHANNEL_CLOSE,this.onWebRTCChannelClose),r.off(i.default.WEBRTC_CONNECT_TIMEOUT,this.onWebRTCConnectTimeout),r.off(i.default.WEBRTC_GET_DATA_TIMEOUT,this.onWebRTCGetDataTimeout),r.destroy(),this.peerRtcInfoByRid[e].peerRtcControllers.splice(n,1))}}makeResponseData(e){const{originRange:t,startTime:r}=this.peerRtcInfoByRid[e];return{range:t.start+"-"+t.end,originRange:t,from:0,path:e,getDataTime:Date.now()-r,startTime:r,uint8:new Uint8Array(0),gotDataByte:0,rtcDataChannelState:null,cPeerSID:"",retryCount:0}}destroy(){for(const e in this.peerRtcInfoByRid)this.releasePeer(e,!0),this.clearPeerInfo(e),this.clearReceivedBufferInfo(e);delete this.sdk,delete this.socketController,delete this.peerRtcInfoByRid,delete this.receivedBufferInfoByRid}getData(e,t,r,i=0,s=5e3,a=0){return n.__awaiter(this,void 0,void 0,(function*(){try{return yield this.createWorkShop(e,t,r,i,s,a),yield this.setUseRanges(e),yield this.createFlowLine(e),yield this.mergeFlowLines(e),this.mergeResult(e)}catch(n){if(n.responseData||(n.responseData=this.makeResponseData(e)),o.default.getInstance().log(`[getData error], rid: ${e}, retryCount: ${a}`,n),a>0)throw n;if(![3001,3003,4e3,4006,4007,4008,4009,4010,4011,4012].includes(n.code))throw n;return yield this.getData(e,t,r,i,s,++a)}}))}}n.__decorate([s.default],c.prototype,"onWebRTCGetDataTimeout",null),n.__decorate([s.default],c.prototype,"onWebRTCConnectTimeout",null),n.__decorate([s.default],c.prototype,"onWebRTCChannelClose",null),t.default=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCLeecher=void 0;const n=r(0),i=n.__importDefault(r(5)),s=n.__importDefault(r(3)),o=n.__importDefault(r(2)),a=r(30);class c extends a.WebRTCBase{constructor(e,t,r,n,i,o){super(e,t,r,n,i),this.needDataByte=0,this.receivedDataByte=0,this.getDataTimeoutTime=5e3,this.index=o,this.socketController.on(s.default.SOCKET_MESSAGE,this.onSocketMessage.bind(this)),this.init()}init(){o.default.getInstance().log(`init ${this.path} index: ${this.index} WebRTCLeecher -- cPeerSocketID: ${this.cPeerSocketID}`),super.init(),this.stateRTCStatistic.offerInit=this.stateRTCStatistic.offerInit?this.stateRTCStatistic.offerInit+1:1,this.dataChannel=this.peerConnection.createDataChannel("receiveDataChannel",{ordered:!0}),this.dataChannel.binaryType="arraybuffer",this.openTimeoutTimer=window.setTimeout(()=>{const e=this.makeResponseData();let t=4007,r="webrtc data channel open timeout";this.hasLocalDescription?this.hasRemoteDescription?this.hasReceivedCandidate?this.hasAddCandidateSuccess||(t=4011,r="no addCandidateSuccess webrtc data channel open timeout"):(t=4010,r="no receivedCandidate webrtc data channel open timeout"):(t=4009,r="no remoteDescription webrtc data channel open timeout"):(t=4008,r="no localDescription webrtc data channel open timeout"),this.getDataOnReject&&this.getDataOnReject({code:t,msg:r,responseData:e}),this.trigger(s.default.WEBRTC_CONNECT_TIMEOUT,this.cPeerSocketID,this.path,this.index)},this.openTimeoutTime),this.dataChannelBindEvent()}dataChannelBindEvent(){this.dataChannel.onmessage=e=>{var t,r,n,i,s;if(!this.leecherGetDataParam)return void(this.getDataOnReject&&this.getDataOnReject({code:4013,msg:"webRTC onmessage no getDataInternalParam",responseData:this.makeResponseData()}));const a=this.leecherGetDataParam.useRange.end-this.leecherGetDataParam.useRange.start+1;if("string"==typeof e.data){const r=parseInt(e.data,10);return this.needDataByte=parseInt(e.data,10),r!==a?(o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received invalid totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, totalSize: `+r),void(this.getDataOnReject&&this.getDataOnReject({code:4014,msg:this.path+" webRTCController received invalid totalSize",responseData:this.makeResponseData()}))):this.receivedU8Buffer?(o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received totalSize after receivedU8Buffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, totalSize: `+r),void(this.getDataOnReject&&this.getDataOnReject({code:4015,msg:this.path+" webRTCController received totalSize after receivedU8Buffer",responseData:this.makeResponseData()}))):(this.receivedU8Buffer=new Uint8Array(parseInt(e.data,10)),this.receivedDataByte=0,void o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, totalSize: `+(null===(t=this.receivedU8Buffer)||void 0===t?void 0:t.byteLength)))}if(0===this.needDataByte)return;if(!this.receivedU8Buffer)return o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data before received totalSize -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),void(this.getDataOnReject&&this.getDataOnReject({code:4016,msg:this.path+" webRTCController received data before received totalSize",responseData:this.makeResponseData()}));let c=new Uint8Array(e.data);if(!c.byteLength)return o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received 0 byte data -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),void(this.getDataOnReject&&this.getDataOnReject({code:4017,msg:this.path+" webRTCController received 0 byte data",responseData:this.makeResponseData()}));if(this.receivedDataByte+c.byteLength>a)return o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data more than needed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),void(this.getDataOnReject&&this.getDataOnReject({code:4018,msg:this.path+" webRTCController received data more than needed",responseData:this.makeResponseData()}));if(this.receivedU8Buffer.set(c,this.receivedDataByte),this.receivedDataByte+=c.byteLength,this.receivedDataByte===(null===(r=this.receivedU8Buffer)||void 0===r?void 0:r.byteLength)){if(o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received all data -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, totalSize: `+(null===(n=this.receivedU8Buffer)||void 0===n?void 0:n.byteLength)),(null===(i=this.receivedU8Buffer)||void 0===i?void 0:i.byteLength)!==a)return this.getDataOnReject&&this.getDataOnReject({code:4019,msg:"webRTC get data not enough",responseData:this.makeResponseData()}),void o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received data not enough -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, totalSize: `+(null===(s=this.receivedU8Buffer)||void 0===s?void 0:s.byteLength));this.getDataOnResolve&&this.getDataOnResolve({code:2e3,msg:"success",responseData:this.makeResponseData()}),this.stateRTCStatistic.getSuccess=++this.stateRTCStatistic.getSuccess||1}},this.dataChannel.onopen=()=>{var e,t,r;if(this.trigger(s.default.WEBRTC_CHANNEL_OPEN,this.cPeerSocketID,this.path,this.index),"open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState)){const e=this.peerConnection.sctp;if(e&&e.maxMessageSize&&(this.maxMessageSize=e.maxMessageSize),o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController dataChannel open -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, maxMessageSize: `+this.maxMessageSize),this.leecherGetDataParam){const e=this.getDataTimeoutTime-(Date.now()-this.leecherGetDataParam.startTime);this.createGetDataTimeout(e);const r=this.leecherGetDataParam,n=Object.assign(Object.assign({},r),{range:`${r.originRange.start}-${r.originRange.end}`,originRange:`${r.originRange.start}-${r.originRange.end}`,useRange:`${r.useRange.start}-${r.useRange.end}`,latency:e});let i={type:"getData",data:JSON.stringify(n),rid:this.path};null===(t=this.socketController)||void 0===t||t.sendMessage(this.cPeerSocketID,i)}null===(r=this.socketController)||void 0===r||r.reportRTCState(this.cPeerSocketID,!0,i.default.RTC_STATE_CODE.DATA_CHANNEL_OPEN_SUCCESS),this.stateRTCStatistic.offerDataChannelOpen=this.stateRTCStatistic.offerDataChannelOpen?this.stateRTCStatistic.offerDataChannelOpen+1:1,this.openTimeoutTimer&&(window.clearTimeout(this.openTimeoutTimer),this.openTimeoutTimer=0)}},this.dataChannel.onclose=()=>{this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path,this.index),o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController dataChannel closed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}}changePeer(){this.getDataOnReject&&this.getDataOnReject({code:4012,msg:"answer peer lose",responseData:this.makeResponseData()}),o.default.getInstance().log(`${this.path} index: ${this.index} answer peer lose -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}createOffer(){var e;null===(e=this.peerConnection)||void 0===e||e.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1}).then(e=>{var t,r,n;if(this.isDestroyed)return;null===(t=this.peerConnection)||void 0===t||t.setLocalDescription(e).then(()=>{this.hasLocalDescription=!0,o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController setLocalDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}).catch(e=>{o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController createOffer setLocalDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, errorMessage: ${""+e}`)}),o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController setLocalDescription from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`);let i={type:"offer",data:JSON.stringify(e),isSameIP:this.isSameIP,qn:null===(r=this.path)||void 0===r?void 0:r.split(".")[0].slice(-5),rid:this.path};null===(n=this.socketController)||void 0===n||n.sendMessage(this.cPeerSocketID,i)},e=>{this.isDestroyed||o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController createOffer error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, error: `+e.toString())})}createGetDataTimeout(e){let t=e||this.getDataTimeoutTime;o.default.getInstance().log(`[createGetDataTimeout] ms: ${e}, getDataTimeoutTime: ${this.getDataTimeoutTime}, getDataParam: `,this.leecherGetDataParam);const{originRange:{start:r,end:n},useRange:{start:i,end:a}}=this.leecherGetDataParam;clearTimeout(this.getDataTimeoutTimer),this.getDataTimeoutTimer=window.setTimeout(()=>{this.getDataOnReject&&this.getDataOnReject({code:4003,msg:"getData timeout",responseData:this.makeResponseData()}),e||this.trigger(s.default.WEBRTC_GET_DATA_TIMEOUT,this.cPeerSocketID,this.path,this.index,this.receivedDataByte)},t)}reset(e){this.createGetDataTimeout(e),this.needDataByte=0,this.receivedDataByte=0,this.receivedU8Buffer=null}getReceivedU8Buffer(){return this.receivedU8Buffer}getReceivedDataByte(){return this.receivedDataByte}getData(e){return new Promise((t,r)=>{var n;let i;e.retryCount&&(i=e.latency-this.openTimeoutTime),e.latency&&(this.getDataTimeoutTime=e.latency),this.leecherGetDataParam=e,this.getDataOnResolve=t,this.getDataOnReject=r,this.reset(i);const s=Object.assign(Object.assign({},e),{range:`${e.originRange.start}-${e.originRange.end}`,originRange:`${e.originRange.start}-${e.originRange.end}`,useRange:`${e.useRange.start}-${e.useRange.end}`,latency:this.getDataTimeoutTime});let o={type:"getData",data:JSON.stringify(s),rid:this.path};null===(n=this.socketController)||void 0===n||n.sendMessage(this.cPeerSocketID,o),this.leecherGetDataParam||this.getDataOnReject&&this.getDataOnReject({code:4006,msg:"webRTC getData data param invalid",responseData:this.makeResponseData()})})}onSocketMessage(e){var t,r;e&&e.fromSocketID&&e.fromSocketID===this.cPeerSocketID&&e.data&&("changePeerV2"!==e.type?e.rid&&e.rid===this.path&&(super.onSocketMessage(e),"answer"===e.type?(o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received answer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),null===(r=this.peerConnection)||void 0===r||r.setRemoteDescription(new RTCSessionDescription(JSON.parse(e.data))).then(()=>{this.hasRemoteDescription=!0,o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController received answer setRemoteDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}).catch(e=>{o.default.getInstance().warn(`${this.path} index: ${this.index} webRTCController received answer setRemoteDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, errorMessage: ${""+e}`)})):"getDataFail"===e.type&&(o.default.getInstance().log(`answer peer get data fail -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),this.getDataOnReject&&this.getDataOnReject({code:e.code,msg:e.msg,responseData:this.makeResponseData()}),this.trigger(s.default.WEBRTC_GET_DATA_TIMEOUT,this.cPeerSocketID,this.path,this.index,this.receivedDataByte))):(null===(t=e.rids)||void 0===t?void 0:t.length)&&e.rids.includes(this.path)&&this.changePeer())}makeResponseData(){var e,t,r,n,i,s,o,a,c;return clearTimeout(this.getDataTimeoutTimer),this.getDataTimeoutTimer=null,{range:(null===(e=this.leecherGetDataParam)||void 0===e?void 0:e.originRange.start)+"-"+(null===(t=this.leecherGetDataParam)||void 0===t?void 0:t.originRange.end),useRange:null===(r=this.leecherGetDataParam)||void 0===r?void 0:r.useRange,originRange:null===(n=this.leecherGetDataParam)||void 0===n?void 0:n.originRange,from:0,path:null===(i=this.leecherGetDataParam)||void 0===i?void 0:i.rid,getDataTime:Date.now()-(null===(s=this.leecherGetDataParam)||void 0===s?void 0:s.startTime),startTime:null===(o=this.leecherGetDataParam)||void 0===o?void 0:o.startTime,uint8:this.receivedU8Buffer,gotDataByte:this.receivedDataByte,rtcDataChannelState:this.dataChannelState,cPeerSID:this.cPeerSocketID,latency:null===(a=this.leecherGetDataParam)||void 0===a?void 0:a.latency,retryCount:null===(c=this.leecherGetDataParam)||void 0===c?void 0:c.retryCount}}destroy(){o.default.getInstance().log(`${this.path} index: ${this.index} webRTCController destroy -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),super.destroy(),this.needDataByte=0,this.receivedDataByte=0,this.receivedU8Buffer=null,this.getDataTimeoutTime=25e3,this.getDataTimeoutTimer&&(window.clearTimeout(this.getDataTimeoutTimer),this.getDataTimeoutTimer=0),this.getDataOnResolve=this.getDataOnReject=null}}t.WebRTCLeecher=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebRTCSeeder=void 0;const n=r(0),i=n.__importDefault(r(5)),s=n.__importDefault(r(3)),o=n.__importDefault(r(2)),a=r(30);class c extends a.WebRTCBase{constructor(e,t,r,n,i){super(e,t,r,n,i),this.answerTimeoutTime=5e3}init(){super.init(),this.answerTimeoutTimer=window.setTimeout(()=>{this.trigger(s.default.WEBRTC_ANSWER_TIMEOUT,this.cPeerSocketID,this.path)},this.answerTimeoutTime),this.stateRTCStatistic.answerInit=this.stateRTCStatistic.answerInit?this.stateRTCStatistic.answerInit+1:1,this.peerConnection.ondatachannel=e=>{o.default.getInstance().log(`${this.path} WebRTCSeeder received dataChannel -- cPeerSocketID: ${this.cPeerSocketID}`),this.dataChannel=e.channel,this.dataChannelBindEvent()}}dataChannelBindEvent(){this.dataChannel.onmessage=e=>{},this.dataChannel.onopen=()=>{var e,t;if(this.trigger(s.default.WEBRTC_CHANNEL_OPEN,this.cPeerSocketID,this.path),"open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState)){const e=this.peerConnection.sctp;e&&e.maxMessageSize&&(this.maxMessageSize=e.maxMessageSize),o.default.getInstance().log(`${this.path} WebRTCSeeder dataChannel open -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, maxMessageSize: `+this.maxMessageSize),this.getDataFromDB(),null===(t=this.socketController)||void 0===t||t.reportRTCState(this.cPeerSocketID,!1,i.default.RTC_STATE_CODE.DATA_CHANNEL_OPEN_SUCCESS),this.stateRTCStatistic.answerDataChannelOpen=this.stateRTCStatistic.answerDataChannelOpen?this.stateRTCStatistic.answerDataChannelOpen+1:1}},this.dataChannel.onclose=()=>{this.trigger(s.default.WEBRTC_CHANNEL_CLOSE,this.cPeerSocketID,this.path),o.default.getInstance().log(`${this.path} WebRTCSeeder dataChannel closed -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}}getDataFromDB(){var e,t,r;this.leecherGetDataParam&&"open"===(null===(e=this.dataChannel)||void 0===e?void 0:e.readyState)&&(null===(r=null===(t=this.sdk)||void 0===t?void 0:t.main)||void 0===r||r.getData(this.leecherGetDataParam).then(e=>{var t;this.isDestroyed||(o.default.getInstance().log("answer peer getData resolveRes",e),o.default.getInstance().log(`answer peer getData success -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`),this.sendData(null===(t=null==e?void 0:e.responseData)||void 0===t?void 0:t.data))},e=>{var t;if(this.isDestroyed)return;const r=null==e?void 0:e.code;let n={type:"getDataFail",data:JSON.stringify(this.leecherGetDataParam),code:r,rid:this.path};null===(t=this.socketController)||void 0===t||t.sendMessage(this.cPeerSocketID,n),o.default.getInstance().log("answer peer getData rejectRes",e),o.default.getInstance().log(`answer peer getData fail -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}))}createAnswer(e){e&&this.peerConnection&&(this.peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(e))).then(()=>{this.hasRemoteDescription=!0,o.default.getInstance().log(`${this.path} webRTCController createAnswer setRemoteDescription success from createOffer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}).catch(e=>{o.default.getInstance().warn(`${this.path} webRTCController createAnswer setRemoteDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, errorMessage: ${""+e}`)}),this.peerConnection.createAnswer().then(e=>{var t,r;if(this.isDestroyed)return;null===(t=this.peerConnection)||void 0===t||t.setLocalDescription(e).then(()=>{this.hasLocalDescription=!0,o.default.getInstance().log(`${this.path} webRTCController setLocalDescription success from createAnswer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`)}).catch(e=>{o.default.getInstance().warn(`${this.path} webRTCController createAnswer setLocalDescription error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, errorMessage: ${""+e}`)}),o.default.getInstance().log(`${this.path} webRTCController setLocalDescription from createAnswer -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}`);let n={type:"answer",data:JSON.stringify(e),rid:this.path};null===(r=this.socketController)||void 0===r||r.sendMessage(this.cPeerSocketID,n)},e=>{this.isDestroyed||o.default.getInstance().warn(`${this.path} webRTCController createAnswer error -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, error: `+e.toString())}))}sendData(e){var t;if(!(null==e?void 0:e.byteLength)||"open"!==(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState))return;const r=e.byteLength,n=r/this.maxMessageSize;o.default.getInstance().log(`${this.path} webRTCController sendData -- cPeerSocketID: ${this.cPeerSocketID}, WebRTC: ${this.constructor.name}, totalSize: `+r),this.dataChannel.send(""+r);for(let t=0;t<n;t++){let r=t*this.maxMessageSize,n=(t+1)*this.maxMessageSize;o.default.getInstance().log(r+" - "+(n-1)),this.dataChannel.send(e.slice(r,n))}this.stateRTCStatistic.sendSuccess=++this.stateRTCStatistic.sendSuccess||1}onSocketMessage(e){e&&e.fromSocketID&&e.fromSocketID===this.cPeerSocketID&&e.data&&e.rid&&e.rid===this.path&&(super.onSocketMessage(e),"offer"===e.type||e.type)}}t.WebRTCSeeder=c},function(e,t,r){"use strict";r.r(t);var n={};r.r(n),r.d(n,"shimGetUserMedia",(function(){return b})),r.d(n,"shimGetDisplayMedia",(function(){return T})),r.d(n,"shimMediaStream",(function(){return S})),r.d(n,"shimOnTrack",(function(){return _})),r.d(n,"shimGetSendersWithDtmf",(function(){return P})),r.d(n,"shimGetStats",(function(){return D})),r.d(n,"shimSenderReceiverGetStats",(function(){return k})),r.d(n,"shimAddTrackRemoveTrackWithNative",(function(){return E})),r.d(n,"shimAddTrackRemoveTrack",(function(){return w})),r.d(n,"shimPeerConnection",(function(){return I})),r.d(n,"fixNegotiationNeeded",(function(){return O}));var i={};r.r(i),r.d(i,"shimGetUserMedia",(function(){return x})),r.d(i,"shimGetDisplayMedia",(function(){return B})),r.d(i,"shimPeerConnection",(function(){return M})),r.d(i,"shimReplaceTrack",(function(){return j}));var s={};r.r(s),r.d(s,"shimGetUserMedia",(function(){return L})),r.d(s,"shimGetDisplayMedia",(function(){return U})),r.d(s,"shimOnTrack",(function(){return $})),r.d(s,"shimPeerConnection",(function(){return G})),r.d(s,"shimSenderGetStats",(function(){return F})),r.d(s,"shimReceiverGetStats",(function(){return W})),r.d(s,"shimRemoveStream",(function(){return V})),r.d(s,"shimRTCDataChannel",(function(){return z})),r.d(s,"shimAddTransceiver",(function(){return K})),r.d(s,"shimGetParameters",(function(){return H})),r.d(s,"shimCreateOffer",(function(){return q})),r.d(s,"shimCreateAnswer",(function(){return J}));var o={};r.r(o),r.d(o,"shimLocalStreamsAPI",(function(){return Y})),r.d(o,"shimRemoteStreamsAPI",(function(){return X})),r.d(o,"shimCallbacksAPI",(function(){return Z})),r.d(o,"shimGetUserMedia",(function(){return Q})),r.d(o,"shimConstraints",(function(){return ee})),r.d(o,"shimRTCIceServerUrls",(function(){return te})),r.d(o,"shimTrackEventTransceiver",(function(){return re})),r.d(o,"shimCreateOfferLegacy",(function(){return ne})),r.d(o,"shimAudioContext",(function(){return ie}));var a={};r.r(a),r.d(a,"shimRTCIceCandidate",(function(){return ae})),r.d(a,"shimMaxMessageSize",(function(){return ce})),r.d(a,"shimSendThrowTypeError",(function(){return de})),r.d(a,"shimConnectionState",(function(){return le})),r.d(a,"removeAllowExtmapMixed",(function(){return ue}));let c=!0,d=!0;function l(e,t,r){const n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function u(e,t,r){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);const s=e=>{const t=r(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,s),i.apply(this,[e,s])};const s=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(r))return s.apply(this,arguments);const n=this._eventMap[t].get(r);return this._eventMap[t].delete(r),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function h(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(c=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function p(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(d=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function f(){if("object"==typeof window){if(c)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function m(e,t){d&&console.warn(e+" is deprecated, please use "+t+" instead.")}function g(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:r}=e;if(r.mozGetUserMedia)t.browser="firefox",t.version=l(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=l(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(r.mediaDevices&&r.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=l(r.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=l(r.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function v(e){return"[object Object]"===Object.prototype.toString.call(e)}function y(e){return v(e)?Object.keys(e).reduce((function(t,r){const n=v(e[r]),i=n?y(e[r]):e[r],s=n&&!Object.keys(i).length;return void 0===i||s?t:Object.assign(t,{[r]:i})}),{}):e}function C(e,t,r){const n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;const s=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)}),s.forEach(t=>{e.forEach(r=>{r.type===n&&r.trackId===t.id&&function e(t,r,n){r&&!n.has(r.id)&&(n.set(r.id,r),Object.keys(r).forEach(i=>{i.endsWith("Id")?e(t,t.get(r[i]),n):i.endsWith("Ids")&&r[i].forEach(r=>{e(t,t.get(r),n)})}))}(e,r,i)})}),i}const R=f;function b(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const r=g(e),n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[i("min",r)]=n.ideal,t.optional.push(e),e={},e[i("max",r)]=n.ideal,t.optional.push(e)):(e[i("",r)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",r)]=n.exact):["min","max"].forEach(e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,r)]=n[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(r.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const o=r.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let r;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?r=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(r=["front"]),r)return t.mediaDevices.enumerateDevices().then(t=>{let o=(t=t.filter(e=>"videoinput"===e.kind)).find(e=>r.some(t=>e.label.toLowerCase().includes(t)));return!o&&t.length&&r.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=s.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),R("chrome: "+JSON.stringify(e)),i(e)})}e.video=n(e.video)}return R("chrome: "+JSON.stringify(e)),i(e)},s=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,n){i(e,e=>{t.webkitGetUserMedia(e,r,e=>{n&&n(s(e))})})}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return i(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(s(e))))}}}function T(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(t=>{const n=r.video&&r.video.width,i=r.video&&r.video.height,s=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:s||3}},n&&(r.video.mandatory.maxWidth=n),i&&(r.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(r)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function S(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function _(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.track.id):{track:r.track};const i=new Event("track");i.track=r.track,i.receiver=n,i.transceiver={receiver:n},i.streams=[t.stream],this.dispatchEvent(i)}),t.stream.getTracks().forEach(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.id):{track:r};const i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=[t.stream],this.dispatchEvent(i)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else u(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function P(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let i=r.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function D(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const i=function(e){const t={};return e.result().forEach(e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{r[t]=e.stat(t)}),t[r.id]=r}),t},s=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const n=function(e){r(s(i(e)))};return t.apply(this,[n,e])}return new Promise((e,r)=>{t.apply(this,[function(t){e(s(i(t)))},r])}).then(r,n)}}function k(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>C(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),u(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>C(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,n;return this.getSenders().forEach(r=>{r.track===e&&(t?n=!0:t=r)}),this.getReceivers().forEach(t=>(t.track===e&&(r?n=!0:r=t),t.track===e)),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function E(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();r.apply(this,arguments);const n=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),i.apply(this,arguments)}}function w(e){if(!e.RTCPeerConnection)return;const t=g(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return E(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r}n.apply(this,[t])};const i=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:r})}function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const i=this.getSenders().find(e=>e.track===t);if(i)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const s=this._streams[r.id];if(s)s.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=s(this,t);e[0].apply(null,[r])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then(e=>s(this,e))}};e.RTCPeerConnection.prototype[t]=n[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(r=>{this._streams[r].getTracks().find(t=>e.track===t)&&(t=this._streams[r])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function I(e){const t=g(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const r=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return r||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function O(e){const t=g(e);u(e,"negotiationneeded",e=>{const r=e.target;if(!(t.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return e})}var A=r(31),N=r.n(A);function x(e){const t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function B(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function M(e){const t=g(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const r=new Event("enabled");r.enabled=e,this.dispatchEvent(r)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const r=N()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let r=!1;return(e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&m("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r}),delete e.url,e.urls=n?t[0]:t,!!t.length}})}(e.iceServers,t.version),f("ICE servers after filtering:",e.iceServers)),new r(e)},e.RTCPeerConnection.prototype=r.prototype}function j(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function L(e){const t=g(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){m("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return"object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(r){return"audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])}}}}function U(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}function $(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function G(e){const t=g(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,s]=arguments;return n.apply(this,[e||null]).then(e=>{if(t.version<53&&!i)try{e.forEach(e=>{e.type=r[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}))})}return e}).then(i,s)}}function F(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function W(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),u(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function V(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){m("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function z(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function K(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach(e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const n=t.apply(this,arguments);if(r){const{sender:t}=n,r=t.getParameters();(!("encodings"in r)||1===r.encodings.length&&0===Object.keys(r.encodings[0]).length)&&(r.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return n})}function H(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function J(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function Y(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(r=>t.call(this,r,e)),e.getVideoTracks().forEach(r=>t.call(this,r,e))},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach(e=>{r.includes(e.track)&&this.removeTrack(e)})})}}function X(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r)})}),t.apply(e,arguments)}}}function Z(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,i=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};let a=function(e,t,r){const n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,r){const n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,r){const n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=a}function Q(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(ee(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t))}function ee(e){return e&&void 0!==e.video?Object.assign({},e,{video:y(e.video)}):e}function te(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let n=e.iceServers[r];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(m("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r])}e.iceServers=t}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function re(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ne(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video")}return t.apply(this,arguments)}}function ie(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var se=r(6),oe=r.n(se);function ae(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),n=oe.a.parseCandidate(e.candidate),i=Object.assign(r,n);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,u(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function ce(e){if(!e.RTCPeerConnection)return;const t=g(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){if(!e||!e.sdp)return!1;const t=oe.a.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=oe.a.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const r=parseInt(t[1],10);return r!=r?-1:r},i=function(e){let r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},s=function(e,r){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const i=oe.a.matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?n=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(r(arguments[0])){const e=n(arguments[0]),t=i(e),r=s(arguments[0],e);let o;o=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return o.apply(this,arguments)}}function de(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},u(e,"datachannel",e=>(t(e.channel,e.target),e))}function le(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function ue(e){if(!e.RTCPeerConnection)return;const t=g(e);if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n")),r.apply(this,arguments)}}const he=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const r=f,c=g(e),d={browserDetails:c,commonShim:a,extractVersion:l,disableLog:h,disableWarnings:p};switch(c.browser){case"chrome":if(!n||!I||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),d;if(null===c.version)return r("Chrome shim can not determine version, not shimming."),d;r("adapter.js shimming chrome."),d.browserShim=n,b(e),S(e),I(e),_(e),w(e),P(e),D(e),k(e),O(e),ae(e),le(e),ce(e),de(e),ue(e);break;case"firefox":if(!s||!G||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),d;r("adapter.js shimming firefox."),d.browserShim=s,L(e),G(e),$(e),V(e),F(e),W(e),z(e),K(e),H(e),q(e),J(e),ae(e),le(e),ce(e),de(e);break;case"edge":if(!i||!M||!t.shimEdge)return r("MS edge shim is not included in this adapter release."),d;r("adapter.js shimming edge."),d.browserShim=i,x(e),B(e),M(e),j(e),ce(e),de(e);break;case"safari":if(!o||!t.shimSafari)return r("Safari shim is not included in this adapter release."),d;r("adapter.js shimming safari."),d.browserShim=o,te(e),ne(e),Z(e),Y(e),X(e),re(e),Q(e),ie(e),ae(e),ce(e),de(e),ue(e);break;default:r("Unsupported browser!")}return d}({window:"undefined"==typeof window?void 0:window});t.default=he},function(e,t,r){"use strict";r.r(t);var n=function(e){var t=this.constructor;return this.then((function(r){return t.resolve(e()).then((function(){return r}))}),(function(r){return t.resolve(e()).then((function(){return t.reject(r)}))}))},i=setTimeout;function s(e){return Boolean(e&&void 0!==e.length)}function o(){}function a(e){if(!(this instanceof a))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],p(e,this)}function c(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,a._immediateFn((function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null!==r){var n;try{n=r(e._value)}catch(e){return void l(t.promise,e)}d(t.promise,n)}else(1===e._state?d:l)(t.promise,e._value)}))):e._deferreds.push(t)}function d(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof a)return e._state=3,e._value=t,void u(e);if("function"==typeof r)return void p((n=r,i=t,function(){n.apply(i,arguments)}),e)}e._state=1,e._value=t,u(e)}catch(t){l(e,t)}var n,i}function l(e,t){e._state=2,e._value=t,u(e)}function u(e){2===e._state&&0===e._deferreds.length&&a._immediateFn((function(){e._handled||a._unhandledRejectionFn(e._value)}));for(var t=0,r=e._deferreds.length;t<r;t++)c(e,e._deferreds[t]);e._deferreds=null}function h(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}function p(e,t){var r=!1;try{e((function(e){r||(r=!0,d(t,e))}),(function(e){r||(r=!0,l(t,e))}))}catch(e){if(r)return;r=!0,l(t,e)}}a.prototype.catch=function(e){return this.then(null,e)},a.prototype.then=function(e,t){var r=new this.constructor(o);return c(this,new h(e,t,r)),r},a.prototype.finally=n,a.all=function(e){return new a((function(t,r){if(!s(e))return r(new TypeError("Promise.all accepts an array"));var n=Array.prototype.slice.call(e);if(0===n.length)return t([]);var i=n.length;function o(e,s){try{if(s&&("object"==typeof s||"function"==typeof s)){var a=s.then;if("function"==typeof a)return void a.call(s,(function(t){o(e,t)}),r)}n[e]=s,0==--i&&t(n)}catch(e){r(e)}}for(var a=0;a<n.length;a++)o(a,n[a])}))},a.resolve=function(e){return e&&"object"==typeof e&&e.constructor===a?e:new a((function(t){t(e)}))},a.reject=function(e){return new a((function(t,r){r(e)}))},a.race=function(e){return new a((function(t,r){if(!s(e))return r(new TypeError("Promise.race accepts an array"));for(var n=0,i=e.length;n<i;n++)a.resolve(e[n]).then(t,r)}))},a._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){i(e,0)},a._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var f=a,m=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();"Promise"in m?m.Promise.prototype.finally||(m.Promise.prototype.finally=n):m.Promise=f}]).default},"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("BPP2PSDK",[],t):"object"==typeof exports?exports.BPP2PSDK=t():e.BPP2PSDK=t();